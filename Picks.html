<!-- Weekly Picks (Gemini AI Generate Config UI + Weekly Picks only) -->

<div class="picksRoot">
  <h2>Weekly Picks</h2>

  <div class="grid">
    <!-- LEFT: Config -->
    <div class="card">
      <h3>Scoring Config (JSON)</h3>
      <p class="muted">Edit the config JSON directly. Save → Run scoring → Refresh picks.</p>

      <!--  AI Prompt + options -->
      <div class="aiBlock">
        <div class="aiRow">
          <textarea id="aiPrompt" rows="3"
            placeholder='Ask Gemini to generate/adjust config. Examples:
- Increase recall (more picks), lower minScore slightly
- Reduce AI hype, focus on manpower policy + layoffs + wages
- Add more reskilling/training terms; tighten scope gate to workplace only'
            spellcheck="false"></textarea>

          <button id="btn_aiGen" class="btn" onclick="picks_generateConfigAI()">Generate via Gemini</button>
        </div>

        <div class="aiOptions">
          <label class="chk">
            <input type="checkbox" id="aiUseBaseline" checked>
            Use current JSON as baseline
          </label>

          <button class="btn" onclick="picks_clearPrompt()">Clear prompt</button>
        </div>

        <div id="ai_status" class="muted" style="margin:6px 0 10px 0;"></div>
      </div>

      <textarea id="cfg_json" rows="18" spellcheck="false"></textarea>

      <div class="btnRow">
        <button class="btn" onclick="picks_reloadConfig()">Reload</button>
        <button class="btnPrimary" onclick="picks_saveConfig()">Save JSON</button>
        <button class="btn" onclick="picks_runScoring()">Run Scoring Now</button>
        <button class="btn" onclick="picks_refresh()">Refresh Picks</button>
      </div>

      <pre id="cfg_status" class="pre"></pre>
    </div>

    <!-- RIGHT: Weekly Picks -->
    <div class="card">
      <h3>Top Picks (Weekly Picks sheet)</h3>
      <div class="row">
        <label>Quick filter</label>
        <input id="filterText" type="text" placeholder="search..." oninput="picks_renderFiltered()">
      </div>
      <div class="row">
        <label>Sort</label>
        <select id="picksSort" onchange="picks_renderFiltered()">
          <option value="default" selected>Sheet order</option>
          <option value="llmScoreDesc">LLM score (desc)</option>
        </select>
      </div>

      <div class="aiBlock">
        <div class="aiRow">
          <textarea id="llmPrompt" rows="3"
            placeholder='LLM ranking prompt (uses existing Theme/POI labels). Example:
Highlight policy levers and workforce risks for 2025-2030.'
            spellcheck="false"></textarea>
          <button id="btn_llmRun" class="btn" onclick="picks_runLlmRank()">Run LLM rank</button>
        </div>
        <div class="aiOptions">
          <label class="chk">
            <input type="checkbox" id="llmFetch" checked>
            Fetch article text
          </label>
          <div class="row" style="grid-template-columns: 120px 1fr; margin:0;">
            <label>Max</label>
            <input id="llmMax" type="text" placeholder="20">
          </div>
          <button class="btn" onclick="picks_fillDefaultPrompt()">Use default prompt</button>
          <button class="btn" onclick="picks_clearLlm()">Clear LLM</button>
        </div>
        <div id="llm_status" class="muted" style="margin:6px 0 10px 0;"></div>
      </div>
      <div id="picks_tableWrap" class="tableWrap"></div>
    </div>
  </div>
</div>

<style>
  .picksRoot { padding: 16px; font-family: Arial, sans-serif; }
  .picksRoot .grid {
    display: grid;
    grid-template-columns: 520px 1fr;
    gap: 16px;
    align-items: start;
  }
  @media (max-width: 1200px){
    .picksRoot .grid { grid-template-columns: 1fr; }
  }

  .picksRoot .card { background: #111; color: #eee; border: 1px solid #2a2a2a; border-radius: 12px; padding: 14px; }
  .picksRoot h2, .picksRoot h3 { margin: 0 0 10px 0; }

  .picksRoot .row { display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center; margin: 8px 0; }
  .picksRoot label { font-size: 12px; color: #bbb; }
  .picksRoot input, .picksRoot textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #333; background: #0b0b0b; color: #eee; }

  .picksRoot textarea {
    resize: vertical;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: 12px;
  }

  .picksRoot .btnRow { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
  .picksRoot .btn, .picksRoot .btnPrimary {
    padding: 8px 10px; border-radius: 10px; border: 1px solid #333; background: #1a1a1a; color: #eee; cursor: pointer;
  }
  .picksRoot .btnPrimary { background: rgba(99,102,241,.25); border-color: rgba(99,102,241,.5); }
  .picksRoot .btn:disabled { opacity: 0.6; cursor: not-allowed; }

  .picksRoot .muted { color: #aaa; font-size: 12px; margin-top: 0; }
  .picksRoot .pre { background: #0b0b0b; border: 1px solid #333; border-radius: 10px; padding: 10px; overflow: auto; max-height: 160px; white-space: pre-wrap; }

  .picksRoot .tableWrap { overflow: auto; border: 1px solid #333; border-radius: 10px; background: #0d0d0d; }
  .picksRoot table { border-collapse: collapse; width: 100%; color: #e8e8e8; }
  .picksRoot th, .picksRoot td { border-bottom: 1px solid #222; padding: 8px; font-size: 12px; vertical-align: top; }
  .picksRoot td { background: #0f0f0f; }
  .picksRoot tr:nth-child(even) td { background: #121212; }
  .picksRoot th { position: sticky; top: 0; background: #1b1b1b; z-index: 1; text-align: left; color: #f5f5f5; }
  .picksRoot a { color: #9bd; }
  .picksRoot .llmRecBadge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }
  .picksRoot .llmRecBadge--yes { background: #1b4d2b; color: #d7ffe6; border: 1px solid #2e7d4f; }
  .picksRoot .llmRecBadge--no { background: #3d1c1c; color: #ffd7d7; border: 1px solid #7a2b2b; }
  .picksRoot .llmRecBadge--unknown { background: #2a2a2a; color: #d8d8d8; border: 1px solid #444; }

  /*  AI block */
  .picksRoot .aiBlock { margin: 8px 0 10px 0; }
  .picksRoot .aiRow {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: start;
    margin: 8px 0;
  }
  .picksRoot .aiOptions{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content: space-between;
    margin-top: 4px;
  }
  .picksRoot .chk{
    display:flex;
    gap:8px;
    align-items:center;
    font-size:12px;
    color:#bbb;
    user-select:none;
  }
  .picksRoot .chk input{ width:auto; padding:0; }

  .picksRoot select{
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #333;
    background: #0b0b0b;
    color: #eee;
  }
</style>

<script>
  let PICKS_ROWS = [];
  let PICKS_HEADERS = [];
  let PICKS_META = {};
  let PICKS_LLM_RESULTS = {};
  let PICKS_LLM_META = null;
  const PICKS_LLM_DEFAULT_PROMPT =
    "Identify the best FutureScans weekly articles to feature. " +
    "Prioritise strong policy/operational levers, credible evidence, and forward-looking workforce/workplace implications " +
    "with clear relevance to Singapore/MOM, using existing Theme/POI labels.";

  function __init_picks() {
    picks_reloadConfig();
    picks_refresh();
    picks_fillDefaultPrompt();

    const p = document.getElementById("aiPrompt");
    if (p) {
      p.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && (ev.ctrlKey || ev.metaKey)) {
          ev.preventDefault();
          picks_generateConfigAI();
        }
      });
    }
  }

  function picks_setStatus(msg) {
    const el = document.getElementById("cfg_status");
    if (el) el.textContent = msg || "";
  }

  function picks_setAiStatus(msg) {
    const el = document.getElementById("ai_status");
    if (el) el.textContent = msg || "";
  }

  function picks_setLlmStatus(msg) {
    const el = document.getElementById("llm_status");
    if (el) el.textContent = msg || "";
  }

  function picks_setAiBusy(isBusy) {
    const btn = document.getElementById("btn_aiGen");
    const inp = document.getElementById("aiPrompt");
    const chk = document.getElementById("aiUseBaseline");
    if (btn) btn.disabled = !!isBusy;
    if (inp) inp.disabled = !!isBusy;
    if (chk) chk.disabled = !!isBusy;
    if (btn) btn.textContent = isBusy ? "Generating..." : "Generate via Gemini";
  }

  function picks_setLlmBusy(isBusy) {
    const btn = document.getElementById("btn_llmRun");
    const inp = document.getElementById("llmPrompt");
    const chk = document.getElementById("llmFetch");
    const max = document.getElementById("llmMax");
    if (btn) btn.disabled = !!isBusy;
    if (inp) inp.disabled = !!isBusy;
    if (chk) chk.disabled = !!isBusy;
    if (max) max.disabled = !!isBusy;
    if (btn) btn.textContent = isBusy ? "Ranking..." : "Run LLM rank";
  }

  function picks_fillDefaultPrompt() {
    const promptEl = document.getElementById("llmPrompt");
    if (promptEl && !promptEl.value.trim()) {
      promptEl.value = PICKS_LLM_DEFAULT_PROMPT;
    }
  }

  function picks_clearPrompt() {
    const p = document.getElementById("aiPrompt");
    if (p) p.value = "";
    picks_setAiStatus("");
  }

  function isValidJson(text){
    try { JSON.parse(String(text || "")); return true; } catch (_) { return false; }
  }

  function picks_generateConfigAI() {
    const promptEl = document.getElementById("aiPrompt");
    const userPrompt = (promptEl ? promptEl.value : "").trim();

    const useBaseline = !!document.getElementById("aiUseBaseline")?.checked;

    let baselineJsonText = "";
    if (useBaseline) {
      baselineJsonText = document.getElementById("cfg_json")?.value || "";
      if (baselineJsonText.trim() && !isValidJson(baselineJsonText)) {
        picks_setAiStatus("Baseline JSON is not valid JSON. Fix it (or uncheck "Use current JSON as baseline") then try again.");
        return;
      }
    }

    picks_setAiBusy(true);
    picks_setAiStatus("Calling Gemini to generate a scoring config...");

    google.script.run
      .withSuccessHandler(res => {
        try {
          if (!res || res.ok !== true || !res.jsonText) {
            picks_setAiStatus("Gemini returned no config. Try a clearer prompt.");
            return;
          }
          if (!isValidJson(res.jsonText)) {
            picks_setAiStatus("Gemini returned invalid JSON (blocked). Try again with a stricter prompt.");
            return;
          }

          const ta = document.getElementById("cfg_json");
          if (ta) ta.value = res.jsonText;

          picks_setAiStatus("Generated  Review the JSON, then click "Save JSON".");
        } catch (err) {
          console.error(err);
          picks_setAiStatus("UI error: " + (err.message || err));
        } finally {
          picks_setAiBusy(false);
        }
      })
      .withFailureHandler(e => {
        console.error(e);
        picks_setAiStatus("Gemini failed: " + (e.message || e));
        picks_setAiBusy(false);
      })
      .ui_generateScoringConfigFromAI_v1(userPrompt, baselineJsonText);
  }

  function picks_reloadConfig() {
    picks_setStatus("Loading config...");
    google.script.run
      .withSuccessHandler(res => {
        const ta = document.getElementById("cfg_json");
        const jsonText = res && res.jsonText ? res.jsonText : "";
        if (ta) ta.value = jsonText;
        picks_setStatus(jsonText ? "Loaded " : "Loaded, but config was empty.");
      })
      .withFailureHandler(e => {
        console.error(e);
        picks_setStatus("Load failed: " + (e.message || e));
      })
      .ui_getScoringConfig_v1();
  }

  function picks_saveConfig() {
    const ta = document.getElementById("cfg_json");
    const txt = ta ? ta.value : "";
    picks_setStatus("Saving...");
    google.script.run
      .withSuccessHandler(res => {
        if (res && res.savedText && ta) ta.value = res.savedText;
        picks_setStatus("Saved ");
      })
      .withFailureHandler(e => {
        console.error(e);
        picks_setStatus("Save failed: " + (e.message || e));
      })
      .ui_saveScoringConfigJson_v1(txt);
  }

  function picks_runScoring() {
    picks_setStatus("Running scoring...");
    google.script.run
      .withSuccessHandler(msg => {
        picks_setStatus((msg || "Scoring done ") + "\nRefreshing picks...");
        picks_refresh();
      })
      .withFailureHandler(e => {
        console.error(e);
        picks_setStatus("Scoring failed: " + (e.message || e));
      })
      .ui_runScoringNow_v1();
  }

  function picks_refresh() {
    picks_setStatus("Refreshing picks...");
    google.script.run
      .withSuccessHandler(data => {
        try {
          const safe = data || { headers: [], rows: [], meta: {} };
          PICKS_HEADERS = safe.headers || [];
          PICKS_ROWS = safe.rows || [];
          PICKS_META = safe.meta || {};
          picks_setStatus(`Refreshed  (${PICKS_ROWS.length} rows)`);
          picks_loadLlmCache();
        } catch (err) {
          console.error(err);
          picks_setStatus("Render failed: " + (err.message || err));
        }
      })
      .withFailureHandler(e => {
        console.error(e);
        picks_setStatus("Refresh failed: " + (e.message || e));
      })
      .ui_getWeeklyPicks_v1();
  }

  function picks_renderFiltered() {
    const inp = document.getElementById("filterText");
    const q = (inp ? inp.value : "").toLowerCase();
    const sortMode = (document.getElementById("picksSort")?.value || "default");

    const rows = !q
      ? PICKS_ROWS
      : PICKS_ROWS.filter(r => JSON.stringify(r).toLowerCase().includes(q));

    const wrap = document.getElementById("picks_tableWrap");
    if (!wrap) return;

    const useLlm = Object.keys(PICKS_LLM_RESULTS || {}).length > 0;
    const recommendedRows = useLlm
      ? rows.filter(r => picks_getLlmRecInfo(PICKS_LLM_RESULTS[picks_buildLlmKey(r)] || {}).isRecommended)
      : rows;
    const displayRows = useLlm ? recommendedRows : rows;

    if (!displayRows.length) {
      const meta = PICKS_META || {};
      const info = meta.sheetName
        ? ` (sheet: ${escapeHtml(meta.sheetName)}, lastRow=${meta.lastRow || 0}, lastCol=${meta.lastCol || 0})`
        : "";
      const llmNote = useLlm ? " No recommended rows (LLM)." : "";
      wrap.innerHTML = `<div style='padding:10px;color:#bbb'>No rows.${llmNote}${info}</div>`;
      return;
    }

    const headers = PICKS_HEADERS.length ? PICKS_HEADERS : Object.keys(displayRows[0]);
    const extraHeaders = useLlm ? ["LLM Score", "LLM Rec", "LLM Summary"] : [];
    const finalHeaders = headers.concat(extraHeaders);

    const sortedRows = displayRows.slice();
    if (sortMode === "llmScoreDesc") {
      sortedRows.sort((a, b) => {
        const aKey = picks_buildLlmKey(a);
        const bKey = picks_buildLlmKey(b);
        const aScore = Number(PICKS_LLM_RESULTS[aKey]?.final_score || 0);
        const bScore = Number(PICKS_LLM_RESULTS[bKey]?.final_score || 0);
        return bScore - aScore;
      });
    }

    let html = "<table><thead><tr>";
    finalHeaders.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
    html += "</tr></thead><tbody>";

    sortedRows.forEach(r => {
      html += "<tr>";
      headers.forEach(h => {
        const v = r[h] == null ? "" : String(r[h]);
        if (isLikelyUrl(v)) {
          html += `<td><a href="${escapeAttr(v)}" target="_blank" rel="noreferrer">open</a></td>`;
        } else {
          html += `<td>${escapeHtml(v)}</td>`;
        }
      });
      if (useLlm) {
        const key = picks_buildLlmKey(r);
        const llm = PICKS_LLM_RESULTS[key] || {};
        const recInfo = picks_getLlmRecInfo(llm);
        html += `<td>${escapeHtml(llm.final_score != null ? String(llm.final_score) : "")}</td>`;
        html += `<td><span class="llmRecBadge ${recInfo.className}">${escapeHtml(recInfo.label)}</span></td>`;
        html += `<td>${escapeHtml(llm.summary || "")}</td>`;
      }
      html += "</tr>";
    });

    html += "</tbody></table>";
    wrap.innerHTML = html;
  }

  // ===== Utils =====
  function isLikelyUrl(s){
    s = String(s || "").trim().toLowerCase();
    return s.startsWith("http://") || s.startsWith("https://");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s); }

  function picks_getField(row, candidates) {
    for (const key of candidates) {
      if (row && row[key] != null && String(row[key]).trim()) return String(row[key]).trim();
    }
    return "";
  }

  function picks_buildLlmKey(row) {
    const link = picks_getField(row, ["Link", "URL", "Url", "link", "url"]);
    const title = picks_getField(row, ["Title", "title"]);
    return link || title;
  }

  function picks_getLlmRecInfo(llm) {
    const raw = String(llm?.publish_recommendation || llm?.recommendation || "").trim().toLowerCase();
    const isYes = ["yes", "y", "publish", "feature", "recommend", "recommended", "include"].some(v => raw === v || raw.includes(v));
    const isNo = ["no", "n", "skip", "exclude", "reject"].some(v => raw === v || raw.includes(v));
    if (isYes) return { label: "Recommend", className: "llmRecBadge--yes", isRecommended: true };
    if (isNo) return { label: "Skip", className: "llmRecBadge--no", isRecommended: false };
    return { label: raw ? raw : "Unknown", className: "llmRecBadge--unknown", isRecommended: false };
  }

  function picks_applyLlmResults(res, options) {
    PICKS_LLM_RESULTS = {};
    const results = Array.isArray(res?.results) ? res.results : [];
    results.forEach(item => {
      if (item && item.key) PICKS_LLM_RESULTS[item.key] = item.llm || {};
    });
    PICKS_LLM_META = res?.meta || null;

    const hasPicks = Array.isArray(PICKS_ROWS) && PICKS_ROWS.length > 0;
    if (!hasPicks && options?.allowFallback) {
      const fallbackRows = results.map(item => ({
        Title: item?.title || "",
        Link: item?.url || ""
      }));
      PICKS_ROWS = fallbackRows;
      PICKS_HEADERS = ["Title", "Link"];
      PICKS_META = {
        sheetName: "Raw Articles (LLM preview)",
        lastRow: fallbackRows.length ? fallbackRows.length + 1 : 0,
        lastCol: PICKS_HEADERS.length
      };
    }
  }

  function picks_loadLlmCache() {
    google.script.run
      .withSuccessHandler(res => {
        if (res && res.ok === true && Array.isArray(res.results) && res.results.length > 0) {
          picks_applyLlmResults(res, { allowFallback: true });
        } else {
          PICKS_LLM_RESULTS = {};
          PICKS_LLM_META = null;
          picks_setLlmStatus("");
        }
        picks_renderFiltered();
      })
      .withFailureHandler(e => {
        console.error(e);
        picks_setLlmStatus("LLM cache load failed: " + (e.message || e));
        picks_renderFiltered();
      })
      .ui_getRawArticlesLlmRankCache_v1();
  }

  function picks_runLlmRank() {
    const prompt = (document.getElementById("llmPrompt")?.value || "").trim();
    if (!prompt) {
      picks_setLlmStatus("Please enter an LLM prompt.");
      return;
    }

    const maxRows = Number((document.getElementById("llmMax")?.value || "").trim() || 20);
    const fetchText = !!document.getElementById("llmFetch")?.checked;
    picks_setLlmBusy(true);
    picks_setLlmStatus("Ranking raw articles...");

    google.script.run
      .withSuccessHandler(res => {
        try {
          if (!res || res.ok !== true) {
            picks_setLlmStatus("LLM rank failed: " + (res?.message || "unknown error"));
            return;
          }
          picks_applyLlmResults(res, { allowFallback: true });
          document.getElementById("picksSort").value = "llmScoreDesc";
          picks_renderFiltered();
          const errList = Array.isArray(res.errors) ? res.errors : [];
          const errCount = errList.length;
          const tokenEstimate = res?.meta?.tokens_estimate;
          const tokenNote = tokenEstimate ? ` - est tokens: ${tokenEstimate}` : "";
          const errPreview = errCount ? ` - first errors: ${errList.slice(0, 3).join(" | ")}` : "";
          const msg = `LLM ranking complete (${res.results?.length || 0} scored from raw articles)` +
            tokenNote +
            (errCount ? ` - ${errCount} errors` : "") +
            errPreview;
          picks_setLlmStatus(msg);
        } catch (err) {
          console.error(err);
          picks_setLlmStatus("LLM rank UI error: " + (err.message || err));
        } finally {
          picks_setLlmBusy(false);
        }
      })
      .withFailureHandler(e => {
        console.error(e);
        picks_setLlmStatus("LLM rank failed: " + (e.message || e));
        picks_setLlmBusy(false);
      })
      .ui_runRawArticlesLlmRank_v2({ prompt, maxRows, fetchText });
  }

  function picks_clearLlm() {
    google.script.run
      .withSuccessHandler(() => {
        PICKS_LLM_RESULTS = {};
        PICKS_LLM_META = null;
        document.getElementById("picksSort").value = "default";
        picks_setLlmStatus("LLM results cleared.");
        picks_renderFiltered();
      })
      .withFailureHandler(e => {
        console.error(e);
        picks_setLlmStatus("LLM clear failed: " + (e.message || e));
      })
      .ui_clearRawArticlesLlmRankCache_v1();
  }

  window.addEventListener("error", (ev) => {
    console.error(ev.error || ev);
    picks_setStatus("UI error: " + (ev.message || "unknown"));
  });
</script>
