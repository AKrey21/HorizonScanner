<div id="raw-root" style="padding:12px;">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    /* ===== Layout: fill available height from index.html container ===== */
    #raw-root{
      --fs-bg:#071326;
      --fs-surface:#0d2247;
      --fs-surface-2:#132e5e;
      --fs-card:#102652;
      --fs-border:#2b4875;
      --fs-border-strong:#3a5a8d;
      --fs-shadow:0 18px 40px rgba(1,8,24,.35);
      --fs-shadow-soft:0 14px 28px rgba(1,8,24,.28);
      --fs-text:#f5f7ff;
      --fs-muted:#c5d0e6;
      --fs-muted-weak:#9aa8c8;
      --fs-placeholder:#8ea0c4;
      --fs-accent:#FF7300;
      --fs-accent-soft:rgba(255,115,0,.18);
      --fs-primary-soft:rgba(13,34,71,.85);
      --fs-header-bg:#0d2247;
      --fs-header-text:#f5f7ff;
      height:100%;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      color:var(--fs-text);
      background: radial-gradient(circle at top left, #0b1f42, var(--fs-bg) 55%);
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
    }

    .top-section{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .page-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--fs-border);
      background: linear-gradient(135deg, rgba(19,46,94,.95), rgba(9,24,52,.95));
      box-shadow: var(--fs-shadow-soft);
    }
    .page-title{
      font-size:18px;
      font-weight:600;
      letter-spacing:.2px;
    }
    .page-sub{
      font-size:12px;
      color:var(--fs-muted);
      margin-top:4px;
    }
    .head-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      color:var(--fs-muted);
      font-size:12px;
    }
    .stat-pill{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: rgba(15,33,69,.6);
      color:var(--fs-text);
    }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .controls.panel{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--fs-border);
      background: linear-gradient(180deg, rgba(13,34,71,.95), rgba(12,27,58,.95));
      box-shadow: var(--fs-shadow-soft);
    }
    .search{
      flex:1; min-width:240px;
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--fs-border-strong);
      background: rgba(9,26,56,.85);
      border-radius:999px; padding:10px 12px;
      color:var(--fs-text);
    }
    .search input{ border:0; outline:0; background:transparent; color:var(--fs-text); width:100%; font-size:13px; }
    .search .hint{ color:var(--fs-muted); font-size:11px; white-space:nowrap; }

    .btn, select, input[type="date"], input[type="text"]{
      border-radius:999px; border:1px solid var(--fs-border);
      background: rgba(19,46,94,.9);
      color:var(--fs-text);
      padding:10px 12px; font-size:12px;
      transition: all .15s ease;
    }
    select option{
      background: var(--fs-surface-2);
      color: var(--fs-text);
    }
    input::placeholder{ color: var(--fs-placeholder); }
    select:focus, input[type="date"]:focus, input[type="text"]:focus{
      outline:2px solid rgba(255,115,0,.35);
      outline-offset:1px;
    }
    .btn{ cursor:pointer; }
    .btn.primary{
      border-color: var(--fs-accent);
      background: var(--fs-accent);
      color: #1b1b1b;
    }
    .btn:not(.primary){
      background: var(--fs-surface-2);
      border-color: var(--fs-border);
      color: var(--fs-text);
    }
    .btn:not(.primary):hover{
      background: #17346a;
      border-color: var(--fs-border-strong);
    }
    .btn.ghost{ background: transparent; }
    .btn.mini{ padding:8px 10px; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .rightControls{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-left:auto;
    }

    .pill{
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--fs-border);
      background: var(--fs-surface-2);
      font-size: 11px;
      color:var(--fs-muted);
      white-space:nowrap;
    }

    .notice{
      border:1px solid var(--fs-border);
      background: var(--fs-surface);
      border-radius:14px;
      padding:10px 12px;
      color:var(--fs-text);
      font-size:12px;
      white-space:pre-wrap;
      display:none;
    }
    .notice.show{ display:block; }
    .notice.ok{ border-color: #2a4f8f; background: #122a56; }
    .notice.err{ border-color: #c3531a; background: #2a1a12; }
    .notice.busy{ border-color: #244377; background: #101f3f; }
    .notice.warn{ border-color: #b25d24; background: #2c1d12; }

    .summaryBar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      border:1px solid var(--fs-border);
      background: rgba(13,34,71,.92);
      border-radius:14px;
      padding:8px 10px;
      color:var(--fs-muted);
      font-size:12px;
    }
    .summaryBar b{ color:var(--fs-text); font-weight:600; }
    .spacer{ flex:1; }

    /* ===== Main stack: filters on top, articles below ===== */
    .main{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
.side{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:10px;
  align-items:start;
}
    .side .summaryBar{
      grid-column:1 / -1;
    }
    .content{
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Cards */
    .box{
      border:1px solid var(--fs-border);
      background: rgba(13,34,71,.92);
      border-radius:14px;
      padding:10px 12px;
      color:var(--fs-text);
      min-width:0;
      box-shadow: var(--fs-shadow-soft);
    }
    .boxHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .label{ font-size:11px; color:var(--fs-muted); margin-bottom:6px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1 1 160px; min-width: 160px; }
    .row.tight > *{ flex: 1 1 120px; min-width: 120px; }
    .row .mini{ flex: 0 0 auto; min-width: 0; }

    /* Chips */
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:2px 10px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: var(--fs-surface);
      color:var(--fs-text);
      font-size:11px;
      max-width: 100%;
    }
    .chip .x{ cursor:pointer; opacity:.75; font-weight:700; line-height:1; }
    .chip .x:hover{ opacity:1; }

    /* ===== Card list area ===== */
    .wrap{
      flex:1 1 auto;
      min-height:0;
      border:1px solid var(--fs-border);
      border-radius:14px;
      overflow:hidden; /* switched by JS depending on Fit screen */
      background: rgba(11,24,50,.9);
      box-shadow: var(--fs-shadow-soft);
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap:12px;
      padding:12px;
    }

    .card{
      border:1px solid var(--fs-border);
      background: linear-gradient(160deg, #0f2854, #0b1e3f);
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:220px;
      box-shadow: var(--fs-shadow);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow: 0 20px 45px rgba(1,8,24,.5);
      border-color: var(--fs-border-strong);
    }

    .card-media{
      height:120px;
      padding:12px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      background:
        radial-gradient(120px 80px at 20% 20%, rgba(255,115,0,.25), transparent 60%),
        radial-gradient(160px 120px at 80% 20%, rgba(245,247,255,.18), transparent 60%),
        linear-gradient(135deg, #0d234b, #081631);
      color:var(--fs-header-text);
    }

    .card-select{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--fs-text);
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: rgba(8,18,40,.78);
      backdrop-filter: blur(4px);
      cursor:pointer;
      user-select:none;
    }
    .card-select input{
      margin:0;
      accent-color: var(--fs-accent);
    }

    .card-date{
      font-size:11px;
      letter-spacing:.3px;
      padding:4px 8px;
      border-radius:999px;
      background: #0b1e3f;
      border:1px solid var(--fs-border);
    }

    .card-body{
      padding:12px 14px 6px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .card-title{
      font-size:14px;
      font-weight:600;
      line-height:1.35;
    }

    .card-desc{
      font-size:12px;
      color:var(--fs-muted);
      line-height:1.4;
    }

    .card-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .card-actions-top{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:wrap;
    }

    .card-actions-note{
      font-size:11px;
      color:var(--fs-muted-weak);
      margin-top:-2px;
    }

    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: #142f60;
      color:var(--fs-text);
      white-space:nowrap;
    }

    .card-footer{
      padding:0 14px 12px;
      display:flex;
      align-items:flex-start;
      gap:8px;
    }

    .card-kws{
      flex:1 1 auto;
      min-width:0;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      max-height:52px;
      overflow:hidden;
    }

    .card-llm-btn{
      margin-left:0;
      flex:0 0 auto;
      white-space:nowrap;
    }

    a{ color:var(--fs-text); text-decoration:none; word-break:break-word; }
    a:hover{ text-decoration:underline; }

    .clickable{
      cursor:pointer;
      text-decoration: underline;
      text-decoration-color: rgba(15,23,42,.35);
      text-underline-offset: 2px;
    }

    .kw-pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: var(--fs-surface-2);
      margin:0;
      font-size: 11px;
      color:var(--fs-muted);
      white-space: nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pager{
      display:flex; gap:8px; align-items:center;
      color:var(--fs-muted); font-size:12px; flex-wrap: wrap;
    }

    .empty{
      padding:18px 14px;
      color:var(--fs-muted);
      font-size:12px;
      display:none;
    }

    .meta{
      color:var(--fs-muted);
      font-size:12px;
      letter-spacing:.2px;
    }

    .report-flow-box{
      border:1px solid var(--fs-border);
      background: rgba(13,34,71,.92);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: var(--fs-shadow-soft);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .report-flow-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .report-flow-status{
      font-size:12px;
      color:var(--fs-muted);
    }
    .report-preview{
      border:1px solid var(--fs-border);
      border-radius:12px;
      overflow:hidden;
      min-height:520px;
      background:#fff;
    }
    .report-preview iframe{
      width:100%;
      min-height:520px;
      border:0;
      background:#fff;
    }

    .llmBadge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.3px;
      border:1px solid transparent;
    }
    .llmBadge--publish{
      background: rgba(37,130,80,.2);
      color:#baf7d4;
      border-color: rgba(37,130,80,.5);
    }
    .llmBadge--maybe{
      background: rgba(223,149,38,.18);
      color:#ffd9a1;
      border-color: rgba(223,149,38,.5);
    }
    .llmBadge--skip{
      background: rgba(196,73,73,.2);
      color:#ffc7c7;
      border-color: rgba(196,73,73,.5);
    }
    .llmBadge--unknown{
      background: rgba(255,255,255,.08);
      color:var(--fs-muted);
      border-color: rgba(255,255,255,.15);
    }

    .llmScore{
      font-weight:600;
    }

    .scoreBadge{
      position:absolute;
      top:10px;
      right:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      letter-spacing:.3px;
      background: rgba(8,18,40,.8);
      border:1px solid rgba(255,255,255,.2);
      color:var(--fs-text);
      backdrop-filter: blur(4px);
    }

    .scoreBadge span{
      color:var(--fs-accent);
      font-weight:800;
      margin-left:6px;
    }

    .card-media{
      position:relative;
      background-size:cover;
      background-position:center;
    }

    .card{
      cursor:pointer;
    }
    .card-details{
      display:none;
      border-top:1px solid var(--fs-border);
      background: rgba(8,18,38,.75);
      padding:10px 12px;
      font-size:12px;
      color:var(--fs-muted);
      line-height:1.45;
    }
    .card.expanded .card-details{ display:block; }
    .detail-title{ color:var(--fs-text); font-weight:600; margin-bottom:4px; }
    .detail-block{ margin-top:8px; }
    .reason-list{ margin:6px 0 0 18px; padding:0; }
    .reason-list li{ margin:3px 0; }

    /* Responsive */
    @media (max-width: 980px){
      .side{ grid-template-columns: 1fr; }
      .card-footer{ flex-wrap:wrap; }
      .card-kws{ max-height:none; }
      .card-actions-top{ justify-content:flex-start; }
    }
  </style>

  <div class="top-section">
    <div class="page-head">
      <div>
        <div class="page-title">All Articles</div>
        <div class="page-sub">Unified view with LLM scoring + recommendations.</div>
      </div>
      <div class="head-actions">
        <span class="stat-pill">Live feed</span>
        <span class="stat-pill">Rapid filters</span>
      </div>
    </div>

    <!-- Top controls -->
    <div class="controls panel">
    <div class="search">
      <span style="opacity:.8;">ðŸ”Ž</span>
      <input id="raw-q" placeholder="Search across title/link/source/theme/poi/keywords..." />
      <span class="hint" id="raw-qHint"></span>
      <span class="pill" id="raw-lastRefresh" title="Last table refresh / ingest time">â€”</span>
    </div>

    <select id="raw-pageSize" title="Rows per page">
      <option value="fit" selected>Fit screen</option>
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="200">200</option>
      <option value="500">500</option>
    </select>

    <button class="btn primary" onclick="raw_apply(true)">Apply</button>
    <button class="btn" onclick="raw_clear()">Clear</button>

      <div class="rightControls">
      <div class="label" style="margin-right:6px;">Actions:</div>
      <div class="row tight" style="flex-wrap:wrap;">
        <button class="btn primary" id="raw-dailySearchBtn" onclick="raw_dailySearchAndPrune()" title="Search today's feed updates, prune anything older than 14 days, and run AI scoring for newly discovered articles.">
          Daily Search and Prune
        </button>
        <button class="btn" id="raw-freshSearchBtn" onclick="raw_freshSearch()" title="Clear all raw articles, ingest the past 14 days from scratch, then run AI scoring.">
          Fresh Search
        </button>
        <button class="btn" id="raw-rereadAllBtn" onclick="raw_rereadRescoreAll()" title="Clear AI rank cache and rescore all current raw articles.">
          Re-read All Articles
        </button>
      </div>
    </div>
    </div>
  </div>

  <details class="panel" id="raw-debugPromptPanel" style="margin-top:10px;">
    <summary class="label" style="cursor:pointer;">LLM debug prompt tools</summary>
    <div class="row" style="margin-top:8px; align-items:flex-start; gap:8px; flex-wrap:wrap;">
      <textarea id="raw-llmPrompt" style="min-height:90px; flex:1 1 560px; background:var(--fs-card); color:var(--fs-text); border:1px solid var(--fs-border); border-radius:12px; padding:10px;" placeholder="Override prompt for AI scoring/debug runs."></textarea>
      <div style="display:flex; flex-direction:column; gap:8px; min-width:220px;">
        <button class="btn" onclick="raw_resetPromptDefault()">Use default prompt</button>
        <button class="btn" onclick="raw_applyPromptPreset('strict')">Preset: strict evidence</button>
        <button class="btn" onclick="raw_applyPromptPreset('summary')">Preset: summary quality</button>
        <button class="btn" onclick="raw_applyPromptPreset('sanity')">Preset: sanity-check JSON</button>
      </div>
    </div>
    <div class="label" style="margin-top:6px;">Applies to Daily Search, Fresh Search, card-level Refresh/Re-read, and Re-read All actions.</div>
  </details>


  <!-- Split area -->
  <div class="main">
    <!-- Sidebar -->
    <div class="side">
      <div class="summaryBar" id="raw-summary">
        <span>Active filters: <b>none</b></span>
        <span class="spacer"></span>
        <span class="pill" id="raw-resultPill">â€”</span>
      </div>

      <div class="box">
        <div class="boxHead">
          <div class="label">Sort + Date range (optional)</div>
          <button class="btn ghost mini" onclick="raw_quickToday()">Today</button>
          <button class="btn ghost mini" onclick="raw_resetToTwoWeeksView()">Reset 14d</button>
        </div>
        <div class="row">
          <select id="raw-sort">
            <option value="dateDesc">Date (newest)</option>
            <option value="dateAsc">Date (oldest)</option>
            <option value="sourceAsc">Source (Aâ†’Z)</option>
            <option value="themeAsc">Theme (Aâ†’Z)</option>
            <option value="poiAsc">POI (Aâ†’Z)</option>
            <option value="titleAsc">Title (Aâ†’Z)</option>
            <option value="llmScoreDesc" selected>LLM score (high â†’ low)</option>
          </select>
          <input id="raw-dateFrom" type="date" title="Date from"/>
          <input id="raw-dateTo" type="date" title="Date to"/>
        </div>
        <div class="row" style="margin-top:6px;">
          <label class="chk" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="raw-llmRecOnly"/>
            LLM recommended only
          </label>
          <span class="pill">Uses latest LLM rank cache</span>
        </div>
        <div class="label" style="margin-top:8px;">Tip: click Theme/Source/POI in cards to quick-filter</div>
      </div>

      <div class="box">
        <div class="label">Facets (type to search â†’ Add)</div>

        <div class="label" style="margin-top:6px;">Theme</div>
        <div class="row tight">
          <input id="raw-themeAdd" type="text" list="raw-themeList" placeholder="e.g. Future of Work" />
          <button class="btn mini" onclick="raw_addFacet('theme')">Add</button>
        </div>
        <datalist id="raw-themeList"></datalist>
        <div class="chips" id="raw-themeChips"></div>

        <div class="label" style="margin-top:10px;">Point of Interest</div>
        <div class="row tight">
          <input id="raw-poiAdd" type="text" list="raw-poiList" placeholder="e.g. Jobs/ Employment..." />
          <button class="btn mini" onclick="raw_addFacet('poi')">Add</button>
        </div>
        <datalist id="raw-poiList"></datalist>
        <div class="chips" id="raw-poiChips"></div>

        <div class="label" style="margin-top:10px;">Source</div>
        <div class="row tight">
          <input id="raw-sourceAdd" type="text" list="raw-sourceList" placeholder="e.g. BBC" />
          <button class="btn mini" onclick="raw_addFacet('source')">Add</button>
        </div>
        <datalist id="raw-sourceList"></datalist>
        <div class="chips" id="raw-sourceChips"></div>
      </div>

      <div class="box">
        <div class="label">Keyword filters</div>

        <div class="row" style="margin-top:6px;">
          <div class="label" style="margin:0;">Include mode</div>
          <select id="raw-kwMode" style="min-width:140px; flex:0 0 auto;">
            <option value="any" selected>ANY</option>
            <option value="all">ALL</option>
          </select>
        </div>

        <div class="label" style="margin-top:6px;">Include</div>
        <div class="row tight">
          <input id="raw-kwIncAdd" type="text" list="raw-kwList" placeholder="e.g. layoffs" />
          <button class="btn mini" onclick="raw_addFacet('kwInc')">Add</button>
        </div>
        <div class="chips" id="raw-kwIncChips"></div>

        <div class="label" style="margin-top:10px;">Exclude</div>
        <div class="row tight">
          <input id="raw-kwExcAdd" type="text" list="raw-kwList" placeholder="e.g. crypto" />
          <button class="btn mini" onclick="raw_addFacet('kwExc')">Add</button>
        </div>
        <datalist id="raw-kwList"></datalist>
        <div class="chips" id="raw-kwExcChips"></div>
      </div>

    </div>

    <!-- Table/content -->
    <div class="content">
      <div class="report-flow-box">
        <div class="report-flow-row">
          <b>Report builder (inline)</b>
          <span class="pill" id="raw-selectedPill">Selected: 0</span>
          <span class="spacer"></span>
          <button class="btn mini" id="raw-selectPageBtn" onclick="raw_selectCurrentPage()">Select page</button>
          <button class="btn mini" id="raw-clearSelectedBtn" onclick="raw_clearSelectedArticles()">Clear selection</button>
          <button class="btn mini primary" id="raw-generateSelectedBtn" onclick="raw_generateReportFromSelection()">Generate report preview</button>
          <button class="btn mini" id="raw-downloadSelectedBtn" onclick="raw_downloadEmlFromSelection()">Download .eml</button>
        </div>
        <div class="report-flow-status" id="raw-reportStatus">Pick 3â€“5 articles, then generate report preview right here.</div>
      </div>

      <div class="meta" id="raw-meta"></div>

      <div class="wrap" id="raw-wrap">
        <div class="cards" id="raw-cards"></div>
        <div class="empty" id="raw-empty">No results. Try clearing some filters.</div>
      </div>

      <div class="pager">
        <button class="btn" id="raw-prev" onclick="raw_prev()">â—€ Prev</button>
        <span id="raw-pageInfo">Page â€”</span>
        <button class="btn" id="raw-next" onclick="raw_next()">Next â–¶</button>
        <span class="pill" id="raw-showing" title="Rows shown on this page">â€”</span>
      </div>

      <details class="panel" id="raw-reportPreviewPanel">
        <summary class="label" style="cursor:pointer;">Inline report preview</summary>
        <div class="report-preview" id="raw-reportPreview">
          <iframe id="raw-reportFrame" title="Generated report preview"></iframe>
        </div>
      </details>
    </div>
  </div>

  <div class="notice" id="raw-notice"></div>
</div>

<script>
  window.__init_raw = function() {
    raw_removeLegacyInlineReportUi();
    raw_bootstrap();
  };

  let rawState = {
    rpcSeq: 0,
    ingestTicker: null,

    boot: null,
    allRows: [],
    filtered: [],

    page: 1,
    pageSize: 25,

    selTheme: new Set(),
    selPoi: new Set(),
    selSource: new Set(),
    selKwInc: new Set(),
    selKwExc: new Set(),
    expandedIds: new Set(),
    loadingIds: new Set(),
    selectedIds: new Set(),
    selectionOrder: [],
    reportBusy: false,

    rowH: 56 // used for Fit screen estimate; refined after render
  };

  const RAW_LLM_DEFAULT_PROMPT = "Score each article for executive horizon-scanning relevance and set publish_recommendation to publish, maybe, or skip.";
  const RAW_LLM_DEBUG_PROMPT_PRESETS = {
    strict: "Score each article with strict evidence standards. Penalize weak sourcing, unsupported claims, and vague policy relevance. Return full JSON with concise summary and concrete score_reasons.",
    summary: "Focus on summary quality. Ensure summary is factual, article-specific, and 80â€“90 words with 1â€“2 bolded phrases. Return full JSON and avoid generic boilerplate.",
    sanity: "Before finalizing, self-check that title/url/date/source align with the given article and that output is valid JSON matching schema."
  };

  const R = (id) => document.getElementById(id);

  function raw_notice(type, msg){
    const box = R("raw-notice");
    box.className = "notice show " + (type || "");
    box.textContent = msg || "";
  }
  function raw_noticeClear(){
    const box = R("raw-notice");
    box.className = "notice";
    box.textContent = "";
  }

  function raw_getActivePrompt(){
    const custom = String((R("raw-llmPrompt")?.value || "")).trim();
    return custom || RAW_LLM_DEFAULT_PROMPT;
  }

  function raw_resetPromptDefault(){
    if (R("raw-llmPrompt")) R("raw-llmPrompt").value = RAW_LLM_DEFAULT_PROMPT;
    raw_notice("ok", "âœ… Using default LLM prompt.");
  }

  function raw_applyPromptPreset(kind){
    const preset = RAW_LLM_DEBUG_PROMPT_PRESETS[String(kind || "").trim()];
    if (!preset) return;
    if (R("raw-llmPrompt")) R("raw-llmPrompt").value = preset;
    raw_notice("ok", "âœ… Applied debug prompt preset: " + kind);
  }

  function raw_escape(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function raw_buildThumb(link){
    const clean = String(link || "").trim();
    if (!clean) return "";
    return "https://image.thum.io/get/width/600/crop/600/" + clean;
  }
  function raw_attr(str){ return encodeURIComponent(String(str || "")); }
  function raw_unattr(str){ try { return decodeURIComponent(String(str||"")); } catch(e){ return String(str||""); } }
  function raw_setBusyUI(isBusy){
    ["raw-dailySearchBtn","raw-freshSearchBtn","raw-rereadAllBtn"].forEach(id => {
      const btn = R(id);
      if (btn) btn.disabled = !!isBusy;
    });
    const refreshBtn = R("raw-refreshBtn");
    if (refreshBtn) refreshBtn.disabled = !!isBusy;
    ["raw-selectPageBtn","raw-clearSelectedBtn","raw-generateSelectedBtn","raw-downloadSelectedBtn"].forEach(id => {
      const btn = R(id);
      if (btn) btn.disabled = !!isBusy;
    });
  }

  function raw_removeLegacyInlineReportUi(){
    const content = document.querySelector("#raw-root .content");
    if (!content) return;

    const selectors = [
      "#raw-report-builder",
      "#raw-selected-count",
      ".raw-report-builder",
      ".raw-inline-report-controls"
    ];
    selectors.forEach((sel) => {
      content.querySelectorAll(sel).forEach((node) => node.remove());
    });

    Array.from(content.children).forEach((node) => {
      const id = String(node.id || "");
      if (["raw-meta", "raw-wrap", "raw-reportPreviewPanel"].includes(id)) return;
      if (node.classList?.contains("report-flow-box") || node.classList?.contains("pager")) return;
      const text = String(node.textContent || "").toLowerCase();
      if (text.includes("open in report generator") || text.includes("generate report from selected")) {
        node.remove();
      }
    });
  }

  function raw_markSelection(id, isSelected){
    const articleId = Number(id || 0);
    if (!articleId) return;
    if (isSelected) {
      if (!rawState.selectedIds.has(articleId)) rawState.selectionOrder.push(articleId);
      rawState.selectedIds.add(articleId);
    } else {
      rawState.selectedIds.delete(articleId);
      rawState.selectionOrder = rawState.selectionOrder.filter(v => v !== articleId);
    }
    raw_updateSelectionSummary();
  }

  function raw_getSelectedRowsOrdered(){
    const rowsById = new Map(rawState.allRows.map(r => [Number(r.id || 0), r]));
    return rawState.selectionOrder
      .map(id => rowsById.get(Number(id || 0)))
      .filter(r => r && rawState.selectedIds.has(Number(r.id || 0)));
  }

  function raw_updateSelectionSummary(msg){
    const rows = raw_getSelectedRowsOrdered().filter(r => String(r.link || "").trim());
    const count = rows.length;
    if (R("raw-selectedPill")) R("raw-selectedPill").textContent = `Selected: ${count}`;
    const status = R("raw-reportStatus");
    if (status) {
      status.textContent = msg || (count < 3
        ? "Pick at least 3 articles to generate the report."
        : (count > 5
          ? "More than 5 selected. First 5 links will be used for report generation."
          : "Ready to generate report from selected articles."));
    }

    const disableGenerate = rawState.reportBusy || count < 3;
    if (R("raw-generateSelectedBtn")) R("raw-generateSelectedBtn").disabled = disableGenerate;
    if (R("raw-downloadSelectedBtn")) R("raw-downloadSelectedBtn").disabled = disableGenerate;
  }

  function raw_getCurrentPageSlice(){
    const total = rawState.filtered.length;
    const pageSize = rawState.pageSize;
    const maxPage = Math.max(1, Math.ceil(total / pageSize));
    const page = Math.min(rawState.page, maxPage);
    const start = (page - 1) * pageSize;
    return rawState.filtered.slice(start, start + pageSize);
  }

  function raw_selectCurrentPage(){
    raw_getCurrentPageSlice().forEach(r => {
      const id = Number(r?.id || 0);
      if (id) raw_markSelection(id, true);
    });
    raw_renderPage();
  }

  function raw_clearSelectedArticles(){
    rawState.selectedIds.clear();
    rawState.selectionOrder = [];
    raw_updateSelectionSummary("Selection cleared.");
    raw_renderPage();
  }

  function raw_getSelectedLinksText(){
    const rows = raw_getSelectedRowsOrdered().filter(r => String(r.link || "").trim());
    const links = rows.map(r => String(r.link || "").trim()).slice(0, 5);
    return links.join("\n");
  }

  function raw_generateReportFromSelection(){
    const linksText = raw_getSelectedLinksText();
    const lines = linksText.split("\n").map(v => v.trim()).filter(Boolean);
    if (lines.length < 3) {
      raw_notice("warn", "Please select at least 3 articles with valid links.");
      raw_updateSelectionSummary();
      return;
    }

    rawState.reportBusy = true;
    raw_updateSelectionSummary("Generating report preview from selected articlesâ€¦");

    google.script.run
      .withSuccessHandler((html) => {
        rawState.reportBusy = false;
        if (R("raw-reportFrame")) R("raw-reportFrame").srcdoc = String(html || "");
        if (R("raw-reportPreviewPanel")) R("raw-reportPreviewPanel").open = true;
        raw_notice("ok", "âœ… Report preview generated from selected articles.");
        raw_updateSelectionSummary("Report preview generated below.");
      })
      .withFailureHandler((err) => {
        rawState.reportBusy = false;
        const msg = err?.message || String(err || "Unknown error");
        raw_notice("err", "âŒ Report generation failed:\n" + msg);
        raw_updateSelectionSummary("Report generation failed.");
      })
      .ui_generateFuturescanReportFromLinks(lines.join("\n"));
  }

  function raw_downloadEmlFromSelection(){
    const linksText = raw_getSelectedLinksText();
    const lines = linksText.split("\n").map(v => v.trim()).filter(Boolean);
    if (lines.length < 3) {
      raw_notice("warn", "Please select at least 3 articles with valid links.");
      raw_updateSelectionSummary();
      return;
    }

    rawState.reportBusy = true;
    raw_updateSelectionSummary("Building Outlook draft (.eml) from selected articlesâ€¦");

    google.script.run
      .withSuccessHandler((res) => {
        rawState.reportBusy = false;
        const filename = res && res.filename ? res.filename : "FutureScans.eml";
        let b64 = res && res.b64 ? res.b64 : "";
        if (!b64) throw new Error("No .eml payload returned.");

        b64 = b64.replace(/-/g, "+").replace(/_/g, "/");
        while (b64.length % 4) b64 += "=";

        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);

        const blob = new Blob([bytes], { type: "message/rfc822" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        raw_notice("ok", "âœ… Downloaded Outlook .eml from selected articles.");
        raw_updateSelectionSummary("Outlook draft downloaded.");
      })
      .withFailureHandler((err) => {
        rawState.reportBusy = false;
        const msg = err?.message || String(err || "Unknown error");
        raw_notice("err", "âŒ Outlook draft generation failed:\n" + msg);
        raw_updateSelectionSummary("Outlook draft generation failed.");
      })
      .ui_buildOutlookEmlFromLinks_v2(lines.join("\n"));
  }

  function raw_runRpc(label, invokeFn, onSuccess, onFailure, opts){
    opts = opts || {};
    const warnAfterMs = Number(opts.warnAfterMs || 15000);
    const hardTimeoutMs = Number(opts.hardTimeoutMs || 120000);

    const seq = ++rawState.rpcSeq;
    const start = Date.now();

    const warnTimer = setTimeout(() => {
      if (seq !== rawState.rpcSeq) return;
      raw_notice("warn", `â³ ${label} is still runningâ€¦ Elapsed: ${Math.round((Date.now()-start)/1000)}s`);
      R("raw-lastRefresh").textContent = "Runningâ€¦";
    }, warnAfterMs);

    const hardTimer = setTimeout(() => {
      if (seq !== rawState.rpcSeq) return;
      raw_notice("err",
        `âš ï¸ ${label} is taking unusually long.\n` +
        `Elapsed: ${Math.round((Date.now()-start)/1000)}s\n\n` +
        `Check Apps Script â†’ Executions for errors/timeouts.`
      );
      R("raw-lastRefresh").textContent = "Timed out";
    }, hardTimeoutMs);

    const gs = google.script.run
      .withSuccessHandler((res) => {
        if (seq !== rawState.rpcSeq) return;
        clearTimeout(warnTimer);
        clearTimeout(hardTimer);
        onSuccess(res);
      })
      .withFailureHandler((err) => {
        if (seq !== rawState.rpcSeq) return;
        clearTimeout(warnTimer);
        clearTimeout(hardTimer);
        onFailure(err);
      });

    invokeFn(gs);
  }

  // ----- chips helpers -----
  function raw_addToSet(setObj, value){
    const v = String(value || "").trim();
    if (!v) return;
    setObj.add(v);
  }
  function raw_removeFromSet(setObj, value){ setObj.delete(value); }

  function raw_renderChips(setObj, chipsElId, onRemove){
    const el = R(chipsElId);
    const arr = Array.from(setObj.values());
    el.innerHTML = arr.map(v => `
      <span class="chip">
        <span>${raw_escape(v)}</span>
        <span class="x" data-v="${raw_attr(v)}">Ã—</span>
      </span>
    `).join("");

    el.querySelectorAll(".x").forEach(x => {
      x.addEventListener("click", () => {
        const v = raw_unattr(x.getAttribute("data-v"));
        onRemove(v);
      });
    });
  }

  function raw_renderAllChips(){
    raw_renderChips(rawState.selTheme, "raw-themeChips", (v)=>{ raw_removeFromSet(rawState.selTheme,v); raw_apply(true); });
    raw_renderChips(rawState.selPoi, "raw-poiChips", (v)=>{ raw_removeFromSet(rawState.selPoi,v); raw_apply(true); });
    raw_renderChips(rawState.selSource, "raw-sourceChips", (v)=>{ raw_removeFromSet(rawState.selSource,v); raw_apply(true); });
    raw_renderChips(rawState.selKwInc, "raw-kwIncChips", (v)=>{ raw_removeFromSet(rawState.selKwInc,v); raw_apply(true); });
    raw_renderChips(rawState.selKwExc, "raw-kwExcChips", (v)=>{ raw_removeFromSet(rawState.selKwExc,v); raw_apply(true); });
  }

  function raw_fillDatalist(listId, facets){
    const dl = R(listId);
    dl.innerHTML = "";
    (facets || []).forEach(it => {
      const opt = document.createElement("option");
      opt.value = it.value;
      opt.label = it.count ? `${it.value} (${it.count})` : it.value;
      dl.appendChild(opt);
    });
  }

  function raw_parseDateInputMs(id, endOfDay){
    const v = (R(id).value || "").trim();
    if (!v) return null;
    const d = new Date(v + "T00:00:00");
    if (endOfDay) d.setHours(23,59,59,999);
    const t = d.getTime();
    return isNaN(t) ? null : t;
  }

  function raw_addFacet(kind){
    const map = {
      theme: { input:"raw-themeAdd", set: rawState.selTheme, norm: (s)=>String(s||"").trim() },
      poi:   { input:"raw-poiAdd", set: rawState.selPoi, norm: (s)=>String(s||"").trim() },
      source:{ input:"raw-sourceAdd", set: rawState.selSource, norm: (s)=>String(s||"").trim() },
      kwInc: { input:"raw-kwIncAdd", set: rawState.selKwInc, norm: (s)=>String(s||"").trim().toLowerCase() },
      kwExc: { input:"raw-kwExcAdd", set: rawState.selKwExc, norm: (s)=>String(s||"").trim().toLowerCase() },
    };
    const cfg = map[kind];
    if (!cfg) return;

    const valRaw = (R(cfg.input).value || "");
    const val = cfg.norm(valRaw);
    if (!val) return;

    raw_addToSet(cfg.set, val);
    R(cfg.input).value = "";
    raw_renderAllChips();
    raw_apply(true);
  }

  function raw_computeFitPageSize(){
    const wrap = R("raw-wrap");
    const cardsEl = R("raw-cards");
    if (!wrap || !cardsEl) return 25;

    const h = wrap.clientHeight || 0;
    const usable = Math.max(120, h - 14);

    const styles = window.getComputedStyle(cardsEl);
    const gap = Number.parseFloat(styles.rowGap || styles.gap || "12") || 12;

    let columns = 1;
    const templateCols = String(styles.gridTemplateColumns || "").trim();
    if (templateCols && templateCols !== "none") {
      columns = Math.max(1, templateCols.split(/\s+/).filter(Boolean).length);
    }

    if (columns === 1) {
      const minCardWidth = 280;
      const containerW = cardsEl.clientWidth || 0;
      if (containerW > 0) {
        columns = Math.max(1, Math.floor((containerW + gap) / (minCardWidth + gap)));
      }
    }

    const firstCard = cardsEl.querySelector(".card");
    const cardH = Math.max(
      80,
      Number(firstCard?.offsetHeight || rawState.rowH || 220)
    );

    const rowsFit = Math.max(1, Math.floor((usable + gap) / (cardH + gap)));
    return Math.max(1, rowsFit * columns);
  }

  function raw_getSelectedPageSize(){
    const v = (R("raw-pageSize").value || "50").trim();
    if (v === "fit") return raw_computeFitPageSize();
    const n = Number(v);
    return (isFinite(n) && n > 0) ? n : 50;
  }

  function raw_syncWrapOverflow(){
    const v = (R("raw-pageSize").value || "").trim();
    // If Fit screen, we aim for no table scroll (pagination only)
    R("raw-wrap").style.overflow = (v === "fit") ? "hidden" : "auto";
  }

  function raw_bootstrap(){
    raw_removeLegacyInlineReportUi();
    raw_notice("busy", "ðŸ”„ Loading tableâ€¦");

    raw_runRpc(
      "Loading table",
      (gs) => gs.ui_getRawArticles_bootstrap_v1(),
      (res) => {
        if (!res || !res.ok) {
          raw_notice("err", "âŒ Failed:\n" + (res?.message || JSON.stringify(res, null, 2)));
          return;
        }

        rawState.boot = res;
        const incomingRows = Array.isArray(res.rows) ? res.rows : [];
        rawState.allRows = incomingRows.map(r => {
          const row = (r && typeof r === "object") ? r : {};
          const title = String(row.title || "");
          const link = String(row.link || "");
          const source = String(row.source || "");
          const theme = String(row.theme || "");
          const poi = String(row.poi || "");
          const keywords = String(row.keywords || "");
          const llmRecommendation = String(row.llmRecommendation || "");
          const llmSummary = String(row.llmSummary || "");
          const llmReasons = Array.isArray(row.llmReasons) ? row.llmReasons.map(x => String(x || "").trim()).filter(Boolean) : [];
          return Object.assign({
            title,
            link,
            source,
            theme,
            poi,
            keywords,
            keywordsList: Array.isArray(row.keywordsList) ? row.keywordsList : [],
            llmScore: Number.isFinite(Number(row.llmScore)) ? Number(row.llmScore) : null,
            llmRecommendation,
            llmSummary,
            llmReasons,
            llmRecommended: !!row.llmRecommended,
            searchText: (title + " " + link + " " + source + " " + theme + " " + poi + " " + keywords + " " + llmRecommendation + " " + llmSummary + " " + llmReasons.join(" ")).toLowerCase()
          }, row);
        });
        rawState.selectedIds.clear();
        rawState.selectionOrder = [];
        rawState.reportBusy = false;
        rawState.page = 1;

        raw_fillDatalist("raw-themeList",  res.facets?.themes || []);
        raw_fillDatalist("raw-poiList",    res.facets?.pois || []);
        raw_fillDatalist("raw-sourceList", res.facets?.sources || []);
        raw_fillDatalist("raw-kwList",     res.facets?.keywords || []);

        raw_renderAllChips();
        raw_apply(true);
        if (R("raw-llmPrompt") && !String(R("raw-llmPrompt").value || "").trim()) {
          R("raw-llmPrompt").value = RAW_LLM_DEFAULT_PROMPT;
        }
      },
      (err) => {
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "âŒ Table load error:\n" + msg);
      },
      { warnAfterMs: 15000, hardTimeoutMs: 120000 }
    );
  }

  function raw_apply(resetToFirstPage){
    if (resetToFirstPage) rawState.page = 1;

    raw_syncWrapOverflow();

    rawState.pageSize = raw_getSelectedPageSize();
    const q = (R("raw-q").value || "").trim().toLowerCase();
    R("raw-qHint").textContent = q ? "Press Enter to apply faster" : "";

    const fromMs = raw_parseDateInputMs("raw-dateFrom", false);
    const toMs   = raw_parseDateInputMs("raw-dateTo", true);

    const themes = rawState.selTheme;
    const pois   = rawState.selPoi;
    const sources= rawState.selSource;
    const kwInc  = rawState.selKwInc;
    const kwExc  = rawState.selKwExc;
    const kwMode = (R("raw-kwMode").value || "any");
    const llmRecOnly = !!R("raw-llmRecOnly").checked;

    let filtered = [];
    try {
      filtered = rawState.allRows.filter(r => {
        if (themes.size && !themes.has(r.theme)) return false;
        if (pois.size && !pois.has(r.poi)) return false;
        if (sources.size && !sources.has(r.source)) return false;

        if (fromMs && r.dateMs && r.dateMs < fromMs) return false;
        if (toMs && r.dateMs && r.dateMs > toMs) return false;

        const klist = (r.keywordsList || []);

        if (kwInc.size) {
          if (kwMode === "all") {
            let okAll = true;
            kwInc.forEach(k => { if (!klist.includes(k)) okAll = false; });
            if (!okAll) return false;
          } else {
            let okAny = false;
            kwInc.forEach(k => { if (klist.includes(k)) okAny = true; });
            if (!okAny) return false;
          }
        }

        if (kwExc.size) {
          let bad = false;
          kwExc.forEach(k => { if (klist.includes(k)) bad = true; });
          if (bad) return false;
        }

        if (q) {
          if (!r.searchText || !r.searchText.includes(q)) return false;
        }
        if (llmRecOnly && !r.llmRecommended) return false;
        return true;
      });
    } catch (err) {
      raw_notice("err", "âŒ Filter error:\n" + (err?.message || String(err)));
      filtered = [];
    }

    // sort
    const sv = (R("raw-sort").value || "dateDesc");
    const cmpStr = (a,b) => String(a||"").localeCompare(String(b||""));
    if (sv === "dateDesc") filtered.sort((a,b)=> (b.dateMs||0) - (a.dateMs||0));
    if (sv === "dateAsc")  filtered.sort((a,b)=> (a.dateMs||0) - (b.dateMs||0));
    if (sv === "sourceAsc")filtered.sort((a,b)=> cmpStr(a.source,b.source));
    if (sv === "themeAsc") filtered.sort((a,b)=> cmpStr(a.theme,b.theme));
    if (sv === "poiAsc")   filtered.sort((a,b)=> cmpStr(a.poi,b.poi));
    if (sv === "titleAsc") filtered.sort((a,b)=> cmpStr(a.title,b.title));
    if (sv === "llmScoreDesc") filtered.sort((a,b)=> (Number(b.llmScore || -1) - Number(a.llmScore || -1)));
    rawState.filtered = filtered;

    raw_updateSummary();
    raw_renderPage();
  }

  function raw_updateSummary(){
    const parts = [];
    if (rawState.selTheme.size)  parts.push(`Theme: ${rawState.selTheme.size}`);
    if (rawState.selPoi.size)    parts.push(`POI: ${rawState.selPoi.size}`);
    if (rawState.selSource.size) parts.push(`Source: ${rawState.selSource.size}`);
    if (rawState.selKwInc.size)  parts.push(`Include: ${rawState.selKwInc.size} (${(R("raw-kwMode").value||"any").toUpperCase()})`);
    if (rawState.selKwExc.size)  parts.push(`Exclude: ${rawState.selKwExc.size}`);
    if (R("raw-llmRecOnly").checked) parts.push("LLM recommended");
    if ((R("raw-dateFrom").value||"") || (R("raw-dateTo").value||"")) parts.push("Date range");
    if ((R("raw-q").value||"").trim()) parts.push("Search");
    R("raw-summary").querySelector("span").innerHTML =
      parts.length ? `Active filters: <b>${raw_escape(parts.join(" â€¢ "))}</b>` : `Active filters: <b>none</b>`;

    R("raw-resultPill").textContent = `Results: ${rawState.filtered.length}`;
  }

  function raw_renderPage(){
    const total = rawState.filtered.length;
    const pageSize = rawState.pageSize;
    const maxPage = Math.max(1, Math.ceil(total / pageSize));
    rawState.page = Math.min(rawState.page, maxPage);

    const start = (rawState.page - 1) * pageSize;
    const slice = rawState.filtered.slice(start, start + pageSize);

    R("raw-pageInfo").textContent = `Page ${rawState.page} / ${maxPage}`;
    R("raw-prev").disabled = (rawState.page <= 1);
    R("raw-next").disabled = (rawState.page >= maxPage);

    const sheet = rawState.boot?.sheet || "Raw Articles";
    const grandTotal = rawState.boot?.meta?.total || rawState.allRows.length;

    R("raw-meta").textContent = `Sheet: ${sheet} â€¢ Total: ${grandTotal} â€¢ Filtered: ${total} â€¢ Rows/page: ${pageSize}`;
    R("raw-showing").textContent = `Showing: ${slice.length}`;
    R("raw-lastRefresh").textContent = "Updated @ " + new Date().toLocaleTimeString();

    const empty = R("raw-empty");
    empty.style.display = total ? "none" : "block";

    const cards = slice.map(r => {
      const title = raw_escape(r.title || "");
      const link = (r.link || "").trim();
      const dateLabel = raw_escape(r.dateDisplay || "No date");
      const titleHtml = link
        ? `<a href="${raw_escape(link)}" target="_blank" rel="noopener noreferrer">${title}</a>`
        : title;

      const srcRaw = String(r.source || "");
      const thmRaw = String(r.theme || "");
      const poiRaw = String(r.poi || "");

      const kws = (r.keywordsList || []).slice(0, 8)
        .map(k => `<span class="kw-pill" title="${raw_escape(k)}">${raw_escape(k)}</span>`).join("");

      const tag = (kind, value) => value
        ? `<span class="tag clickable" data-kind="${kind}" data-v="${raw_attr(value)}">${raw_escape(value)}</span>`
        : "â€”";

      const llmScore = Number.isFinite(Number(r.llmScore)) ? Number(r.llmScore).toFixed(1) : "â€”";
      const recRaw = String(r.llmRecommendation || "").trim();
      const recNorm = recRaw ? recRaw.toLowerCase() : "unknown";
      const recClass = recNorm === "publish" ? "publish" : (recNorm === "maybe" ? "maybe" : (recNorm === "skip" ? "skip" : "unknown"));
      const recLabel = recRaw || "Unknown";
      const thumb = raw_buildThumb(link);
      const mediaStyle = thumb
        ? `style="background-image: linear-gradient(135deg, rgba(6,16,36,.85), rgba(6,16,36,.4)), url('${raw_escape(thumb)}')"`
        : `style="background-image: linear-gradient(135deg, rgba(6,16,36,.9), rgba(6,16,36,.6))"`;

      const descParts = [];
      if (srcRaw) descParts.push(`Source: ${raw_escape(srcRaw)}`);
      if (thmRaw) descParts.push(`Theme: ${raw_escape(thmRaw)}`);
      if (poiRaw) descParts.push(`POI: ${raw_escape(poiRaw)}`);
      const desc = descParts.length ? descParts.join(" â€¢ ") : "No category tags available yet.";

      const articleId = Number(r.id || 0);
      const isSelected = rawState.selectedIds.has(articleId);
      const isExpanded = rawState.expandedIds.has(articleId);
      const isLlmLoading = rawState.loadingIds.has(articleId);
      const reasonItems = (r.llmReasons || []).map(x => `<li>${raw_escape(x)}</li>`).join("");
      const summaryText = String(r.llmSummary || "").trim();
      const recommendationLabel = recClass === "publish" ? "Yes" : (recClass === "maybe" ? "Maybe" : "No");
      const allKeywords = (r.keywordsList || []).map(k => `<span class="kw-pill" title="${raw_escape(k)}">${raw_escape(k)}</span>`).join("");
      const llmBtnLabel = isLlmLoading
        ? "Loading..."
        : (summaryText ? "Refresh LLM" : "Load LLM");
      const llmRereadLabel = isLlmLoading ? "Working..." : "Re-read & rescore";

      return `
        <article class="card ${isExpanded ? "expanded" : ""}" data-id="${articleId}">
          <div class="card-media" ${mediaStyle}>
            <label class="card-select" data-stop-card-toggle="1" title="Select article for report generation">
              <input class="raw-card-select" type="checkbox" data-id="${articleId}" ${isSelected ? "checked" : ""}/>
              <span>Select</span>
            </label>
            <span class="card-date">${dateLabel}</span>
            <div class="scoreBadge">LLM<span>${llmScore}</span></div>
          </div>
          <div class="card-body">
            <div class="card-title">${titleHtml}</div>
            <div class="card-desc">${desc}</div>
            <div class="card-actions-top">
              <button class="btn mini card-llm-btn" data-action="llm-refresh" data-id="${articleId}" ${isLlmLoading ? "disabled" : ""} title="Refresh LLM output using the currently saved article text">${llmBtnLabel}</button>
              <button class="btn mini card-llm-btn" data-action="llm-reread" data-id="${articleId}" ${isLlmLoading ? "disabled" : ""} title="Fetch article text again, then rerun LLM scoring and summary">${llmRereadLabel}</button>
            </div>
            <div class="card-actions-note">Refresh = use saved text â€¢ Re-read = fetch article again</div>
            <div class="card-tags">
              ${tag("source", srcRaw)}
              ${tag("theme", thmRaw)}
              ${tag("poi", poiRaw)}
              <span class="llmBadge llmBadge--${recClass}">${raw_escape(recLabel)}</span>
            </div>
          </div>
          <div class="card-footer">
            <div class="card-kws">${kws}</div>
          </div>
          <div class="card-details">
            <div class="detail-title">Recommendation: ${recommendationLabel} (${raw_escape(recLabel)})</div>
            <div><b>Why:</b> ${(reasonItems ? `<ul class="reason-list">${reasonItems}</ul>` : "No LLM reasons recorded yet.")}</div>
            <div class="detail-block"><b>Summary:</b> ${summaryText ? raw_escape(summaryText) : "No summary available yet."}</div>
            <div class="detail-block"><b>All keyword tags:</b> ${allKeywords || "â€”"}</div>
          </div>
        </article>
      `;
    }).join("");

    R("raw-cards").innerHTML = cards;

    const firstCard = R("raw-cards")?.querySelector(".card");
    if (firstCard && firstCard.offsetHeight) rawState.rowH = firstCard.offsetHeight;

    raw_updateSelectionSummary();
    raw_noticeClear();
  }

  function raw_refreshSearchText(row){
    if (!row || typeof row !== "object") return;
    const llmReasons = Array.isArray(row.llmReasons) ? row.llmReasons : [];
    row.searchText = (
      String(row.title || "") + " " +
      String(row.link || "") + " " +
      String(row.source || "") + " " +
      String(row.theme || "") + " " +
      String(row.poi || "") + " " +
      String(row.keywords || "") + " " +
      String(row.llmRecommendation || "") + " " +
      String(row.llmSummary || "") + " " +
      llmReasons.join(" ")
    ).toLowerCase();
  }

  function raw_isPublishRecommendation_(value){
    const rec = String(value || "").trim().toLowerCase();
    if (!rec) return false;
    return rec === "publish" || rec.includes("publish");
  }

  function raw_loadLlmThoughtsForCardPromise(articleId, opts){
    return new Promise((resolve, reject) => {
      opts = opts || {};
      const fetchText = opts.fetchText === true;
      const id = Number(articleId || 0);
      if (!id) { resolve({ skipped: true }); return; }

      raw_runRpc(
        "Card LLM thoughts",
        (gs) => gs.ui_runRawArticleLlmThoughts_v1({ id, prompt: raw_getActivePrompt(), fetchText }),
        (res) => {
          if (!res || res.ok !== true || !res.row) {
            reject(new Error(res?.message || "Could not load LLM thoughts for this article."));
            return;
          }

          const row = res.row || {};
          const target = rawState.allRows.find((r) => Number(r?.id || 0) === id);
          if (target) {
            target.llmScore = Number.isFinite(Number(row.llmScore)) ? Number(row.llmScore) : null;
            target.llmRecommendation = String(row.llmRecommendation || "").trim();
            target.llmSummary = String(row.llmSummary || "").trim();
            target.llmReasons = Array.isArray(row.llmReasons) ? row.llmReasons.map(x => String(x || "").trim()).filter(Boolean) : [];
            target.llmRecommended = !!row.llmRecommended;
            raw_refreshSearchText(target);
          }
          resolve({ ok: true, row: res.row || {} });
        },
        (err) => {
          const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
          reject(new Error(msg));
        },
        { warnAfterMs: 12000, hardTimeoutMs: 3 * 60 * 1000 }
      );
    });
  }

  async function raw_rereadPublishBatch(){
    const targets = (rawState.filtered || []).filter((r) => raw_isPublishRecommendation_(r?.llmRecommendation));
    if (!targets.length) {
      raw_notice("warn", "No publish-recommended articles in the current filtered results.");
      return;
    }

    raw_setBusyUI(true);
    let done = 0;
    let failed = 0;

    raw_notice("busy", `ðŸ§  Re-reading + reloading ${targets.length} publish article(s)...`);
    for (const row of targets) {
      const id = Number(row?.id || 0);
      if (!id) continue;

      rawState.loadingIds.add(id);
      raw_renderPage();
      R("raw-lastRefresh").textContent = `Bulk re-read... ${done + 1}/${targets.length}`;

      try {
        await raw_loadLlmThoughtsForCardPromise(id, { fetchText: true });
        done += 1;
      } catch (err) {
        failed += 1;
      } finally {
        rawState.loadingIds.delete(id);
      }
    }

    raw_setBusyUI(false);
    raw_apply(false);

    if (failed > 0) {
      raw_notice("warn", `âš ï¸ Bulk re-read finished with partial errors. Updated: ${done}/${targets.length}, failed: ${failed}.`);
    } else {
      raw_notice("ok", `âœ… Bulk re-read complete. Updated ${done} publish article(s).`);
    }
    R("raw-lastRefresh").textContent = "Bulk re-read done @ " + new Date().toLocaleTimeString();
  }

  function raw_loadLlmThoughtsForCard(articleId, opts){
    opts = opts || {};
    const fetchText = opts.fetchText === true;
    const id = Number(articleId || 0);
    if (!id || rawState.loadingIds.has(id)) return;

    rawState.loadingIds.add(id);
    raw_renderPage();
    raw_notice("busy", fetchText
      ? "ðŸ§  Re-reading article text + loading fresh LLM thoughts..."
      : "ðŸ§  Loading LLM thoughts for this article...");
    R("raw-lastRefresh").textContent = fetchText ? "Re-reading + scoring card LLM..." : "Loading card LLM...";

    raw_runRpc(
      "Card LLM thoughts",
      (gs) => gs.ui_runRawArticleLlmThoughts_v1({ id, prompt: raw_getActivePrompt(), fetchText }),
      (res) => {
        rawState.loadingIds.delete(id);

        if (!res || res.ok !== true || !res.row) {
          raw_notice("err", "âŒ Could not load LLM thoughts for this article.\n" + (res?.message || JSON.stringify(res, null, 2)));
          R("raw-lastRefresh").textContent = "Card LLM failed";
          raw_renderPage();
          return;
        }

        const row = res.row || {};
        const target = rawState.allRows.find((r) => Number(r?.id || 0) === id);
        if (target) {
          target.llmScore = Number.isFinite(Number(row.llmScore)) ? Number(row.llmScore) : null;
          target.llmRecommendation = String(row.llmRecommendation || "").trim();
          target.llmSummary = String(row.llmSummary || "").trim();
          target.llmReasons = Array.isArray(row.llmReasons) ? row.llmReasons.map(x => String(x || "").trim()).filter(Boolean) : [];
          target.llmRecommended = !!row.llmRecommended;
          raw_refreshSearchText(target);
        }

        raw_notice("ok", fetchText
          ? "âœ… Fresh LLM thoughts loaded after re-reading article text."
          : "âœ… LLM thoughts loaded for this article.");
        R("raw-lastRefresh").textContent = (fetchText ? "Card re-read + LLM updated @ " : "Card LLM updated @ ") + new Date().toLocaleTimeString();
        raw_apply(false);
      },
      (err) => {
        rawState.loadingIds.delete(id);
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "âŒ Card LLM RPC error:\n" + msg);
        R("raw-lastRefresh").textContent = "Card LLM failed";
        raw_renderPage();
      },
      { warnAfterMs: 12000, hardTimeoutMs: 3 * 60 * 1000 }
    );
  }

  function raw_clear(){
    R("raw-q").value = "";
    R("raw-dateFrom").value = "";
    R("raw-dateTo").value = "";
    R("raw-sort").value = "llmScoreDesc";
    R("raw-kwMode").value = "any";
    R("raw-llmRecOnly").checked = false;

    rawState.selTheme.clear();
    rawState.selPoi.clear();
    rawState.selSource.clear();
    rawState.selKwInc.clear();
    rawState.selKwExc.clear();

    raw_renderAllChips();
    raw_apply(true);
  }

  function raw_prev(){ if (rawState.page > 1) { rawState.page--; raw_renderPage(); } }
  function raw_next(){
    const maxPage = Math.max(1, Math.ceil(rawState.filtered.length / rawState.pageSize));
    if (rawState.page < maxPage) { rawState.page++; raw_renderPage(); }
  }

  function raw_quickToday(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const iso = `${y}-${m}-${day}`;
    R("raw-dateFrom").value = iso;
    R("raw-dateTo").value = iso;
    raw_apply(true);
  }

  function raw_resetToTwoWeeksView(){
    raw_clear();
    const d = new Date();
    const from = new Date(d.getTime());
    from.setDate(from.getDate() - 13);
    const toIso = d.toISOString().slice(0,10);
    const fromIso = from.toISOString().slice(0,10);
    R("raw-dateFrom").value = fromIso;
    R("raw-dateTo").value = toIso;
    raw_apply(true);
    raw_notice("ok", "âœ… Filters reset to last 14 days.");
  }

  function raw_pruneToTwoWeeksNow(){
    raw_setBusyUI(true);
    raw_notice("busy", "ðŸ§¹ Pruning Raw Articles older than 14 daysâ€¦");
    raw_runRpc(
      "Prune Raw Articles",
      (gs) => gs.ui_pruneRawArticlesNow_v1({ days: 14 }),
      (res) => {
        raw_setBusyUI(false);
        if (!res || res.ok !== true) {
          raw_notice("err", "âŒ Prune failed.\n" + JSON.stringify(res, null, 2));
          return;
        }
        const prune = res.prune || {};
        raw_notice("ok", `âœ… Prune complete.\nRemoved: ${prune.removed || 0}\nKept: ${prune.kept || 0}\nWindow: ${prune.maxAgeDays || 14} days`);
        raw_resetToTwoWeeksView();
        raw_bootstrap();
      },
      (err) => {
        raw_setBusyUI(false);
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "âŒ Prune RPC error:\n" + msg);
      },
      { warnAfterMs: 15000, hardTimeoutMs: 180000 }
    );
  }

  // quick-filter tags + card expand on click
  R("raw-cards").addEventListener("click", (e) => {
    const t = e.target;
    if (!t) return;

    if (t.closest("[data-stop-card-toggle='1']")) return;

    if (t.closest("a")) return;

    const llmBtn = t.closest('[data-action="llm-refresh"], [data-action="llm-reread"]');
    if (llmBtn && llmBtn.dataset) {
      const id = Number(llmBtn.dataset.id || 0);
      const action = String(llmBtn.dataset.action || "").trim();
      if (id) raw_loadLlmThoughtsForCard(id, { fetchText: action === "llm-reread" });
      return;
    }

    const chip = t.closest(".clickable");
    if (chip && chip.dataset) {
      const kind = chip.dataset.kind;
      const v = raw_unattr(chip.dataset.v || "");
      if (!v) return;

      if (kind === "theme") raw_addToSet(rawState.selTheme, v);
      if (kind === "poi") raw_addToSet(rawState.selPoi, v);
      if (kind === "source") raw_addToSet(rawState.selSource, v);

      raw_renderAllChips();
      raw_apply(true);
      return;
    }

    const card = t.closest(".card");
    if (!card) return;
    const id = Number(card.getAttribute("data-id") || 0);
    if (!id) return;

    if (rawState.expandedIds.has(id)) rawState.expandedIds.delete(id);
    else rawState.expandedIds.add(id);

    raw_renderPage();
  });

  R("raw-cards").addEventListener("change", (e) => {
    const t = e.target;
    if (!(t instanceof HTMLInputElement)) return;
    if (!t.classList.contains("raw-card-select")) return;
    const id = Number(t.dataset.id || 0);
    if (!id) return;
    raw_markSelection(id, !!t.checked);
  });

  // Search debounce (fast)
  R("raw-q").addEventListener("input", () => {
    clearTimeout(window.__rawQTimer);
    window.__rawQTimer = setTimeout(() => raw_apply(true), 180);
  });

  // Changes trigger apply
  ["raw-pageSize","raw-sort","raw-dateFrom","raw-dateTo","raw-kwMode"].forEach(id => {
    R(id).addEventListener("change", () => raw_apply(true));
  });
  R("raw-llmRecOnly").addEventListener("change", () => raw_apply(true));

  // Fit screen: refresh on resize (debounced)
  window.addEventListener("resize", () => {
    clearTimeout(window.__rawResizeT);
    window.__rawResizeT = setTimeout(() => {
      if ((R("raw-pageSize").value || "") === "fit") raw_apply(true);
    }, 200);
  });

  // Enter key = quick apply + also add chips when focused on facet inputs
  document.addEventListener("keydown", (e) => {
    const el = document.activeElement;
    if (e.key !== "Enter") return;

    if (el === R("raw-q")) { raw_apply(true); return; }
    if (el === R("raw-themeAdd")) { raw_addFacet("theme"); return; }
    if (el === R("raw-poiAdd")) { raw_addFacet("poi"); return; }
    if (el === R("raw-sourceAdd")) { raw_addFacet("source"); return; }
    if (el === R("raw-kwIncAdd")) { raw_addFacet("kwInc"); return; }
    if (el === R("raw-kwExcAdd")) { raw_addFacet("kwExc"); return; }
  });

  function raw_dailySearchAndPrune(){
    raw_importRss("daily");
  }

  function raw_freshSearch(){
    raw_setBusyUI(true);
    raw_notice("busy", "â³ Fresh search step 1/3â€¦\nClearing Raw Articles + LLM cache.");
    R("raw-lastRefresh").textContent = "Fresh search step 1/3â€¦";

    raw_runRpc(
      "Fresh search step 1/3 (reset)",
      (gs) => gs.ui_resetRawArticlesForFreshSearch_v1(),
      () => {
        raw_notice("busy", "â³ Fresh search step 2/3â€¦\nImporting RSS from the last 14 days.");
        R("raw-lastRefresh").textContent = "Fresh search step 2/3â€¦";

        raw_runRpc(
          "Fresh search step 2/3 (import)",
          (gs) => gs.ui_importRSS_14days_v1(),
          (importRes) => {
            if (!importRes || importRes.ok !== true) {
              raw_setBusyUI(false);
              raw_notice("err", "âŒ Fresh search failed during import.\n\nFULL RESPONSE:\n" + JSON.stringify(importRes, null, 2));
              R("raw-lastRefresh").textContent = "Failed";
              return;
            }

            const s = importRes.stats || {};
            const imported = Number(s.imported || 0);
            if (imported <= 0) {
              raw_setBusyUI(false);
              raw_notice(
                "ok",
                `âœ… Fresh search complete.\nNo new articles imported, so AI scoring was skipped.\n\nImported: ${s.imported || 0}\nDuplicates skipped: ${s.skippedDuplicate || 0}\nOld/invalid date skipped: ${s.skippedDate || 0}\nNo-match skipped: ${s.skippedNoMatch || 0}\nMissing fields skipped: ${s.skippedMissingFields || 0}\nFeed errors: ${s.feedErrors || 0}`
              );
              R("raw-lastRefresh").textContent = "Fresh search done @ " + new Date().toLocaleTimeString();
              raw_bootstrap();
              return;
            }

            raw_notice("busy", `â³ Fresh search step 3/3â€¦
Scoring ${imported} imported article(s) with AI.`);
            R("raw-lastRefresh").textContent = "Fresh search step 3/3â€¦";

            let scoringPass = 0;
            let lastScoreMeta = null;

            const runNextScoringPass = () => {
              scoringPass += 1;
              raw_runRpc(
                `Fresh search step 3/3 (LLM scoring pass ${scoringPass})`,
                (gs) => gs.ui_runDailyLlmScoringForNewArticles_v1({ timeBudgetMs: 45000 }),
                (scoreRes) => {
                  if (!scoreRes || scoreRes.ok !== true) {
                    raw_setBusyUI(false);
                    raw_notice("err", "âŒ Fresh search failed during AI scoring.\n\nFULL RESPONSE:\n" + JSON.stringify(scoreRes, null, 2));
                    R("raw-lastRefresh").textContent = "Failed";
                    return;
                  }

                  const llm = scoreRes.llm || {};
                  const meta = llm.meta || {};
                  lastScoreMeta = meta;
                  const scored = Number(meta.scored_total || 0);
                  const pending = Number(meta.pending_rows || 0);
                  const total = Number(meta.total_rows || imported || 0);
                  const recommended = Number(meta.recommended_total || 0);

                  if (llm.status === "in_progress") {
                    raw_notice(
                      "busy",
                      `â³ Fresh search step 3/3â€¦ (pass ${scoringPass})
AI scoring in progress.
Scored: ${scored} / ${total}
Pending: ${pending}
Recommended: ${recommended}`
                    );
                    R("raw-lastRefresh").textContent = `Fresh search step 3/3â€¦ pass ${scoringPass}`;
                    setTimeout(runNextScoringPass, 250);
                    return;
                  }

                  raw_setBusyUI(false);
                  raw_notice(
                    "ok",
                    `âœ… Fresh search complete.

Imported: ${s.imported || 0}
Duplicates skipped: ${s.skippedDuplicate || 0}
Old/invalid date skipped: ${s.skippedDate || 0}
No-match skipped: ${s.skippedNoMatch || 0}
Missing fields skipped: ${s.skippedMissingFields || 0}
Feed errors: ${s.feedErrors || 0}

AI scored: ${Number(lastScoreMeta?.scored_total || 0)} / ${Number(lastScoreMeta?.total_rows || imported || 0)}
AI pending: ${Number(lastScoreMeta?.pending_rows || 0)}
AI recommended: ${Number(lastScoreMeta?.recommended_total || 0)}
AI scoring: ${llm.message || llm.status || "done"}`
                  );

                  R("raw-lastRefresh").textContent = "Fresh search done @ " + new Date().toLocaleTimeString();
                  raw_bootstrap();
                },
                (err) => {
                  raw_setBusyUI(false);
                  const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
                  raw_notice("err", "âŒ Fresh search RPC error (step 3/3):\n" + msg);
                  R("raw-lastRefresh").textContent = "Failed";
                },
                { warnAfterMs: 35000, hardTimeoutMs: 8 * 60 * 1000 }
              );
            };

            runNextScoringPass();

          },
          (err) => {
            raw_setBusyUI(false);
            const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
            raw_notice("err", "âŒ Fresh search RPC error (step 2/3):\n" + msg);
            R("raw-lastRefresh").textContent = "Failed";
          },
          { warnAfterMs: 35000, hardTimeoutMs: 8 * 60 * 1000 }
        );
      },
      (err) => {
        raw_setBusyUI(false);
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "âŒ Fresh search RPC error (step 1/3):\n" + msg);
        R("raw-lastRefresh").textContent = "Failed";
      },
      { warnAfterMs: 20000, hardTimeoutMs: 2 * 60 * 1000 }
    );
  }

  function raw_rereadRescoreAll(){
    raw_setBusyUI(true);
    raw_notice("busy", "ðŸ§  Re-reading and rescoring all articlesâ€¦");
    R("raw-lastRefresh").textContent = "Rescoring allâ€¦";

    raw_runRpc(
      "Re-read all articles",
      (gs) => gs.ui_rereadRescoreAllRawArticles_v1({ prompt: raw_getActivePrompt() }),
      (res) => {
        raw_setBusyUI(false);

        if (!res || res.ok !== true) {
          raw_notice("err", "âŒ Re-read all failed.\n\nFULL RESPONSE:\n" + JSON.stringify(res, null, 2));
          R("raw-lastRefresh").textContent = "Failed";
          return;
        }

        const llm = res.llm || {};
        const meta = llm.meta || {};
        raw_notice(
          "ok",
          `âœ… Re-read + rescore complete.\nStatus: ${llm.status || "done"}\nScored: ${meta.scored_total || 0}\nRecommended: ${meta.recommended_total || 0}`
        );

        R("raw-lastRefresh").textContent = "Rescore done @ " + new Date().toLocaleTimeString();
        raw_bootstrap();
      },
      (err) => {
        raw_setBusyUI(false);
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "âŒ Re-read all RPC error:\n" + msg);
        R("raw-lastRefresh").textContent = "Failed";
      },
      { warnAfterMs: 25000, hardTimeoutMs: 8 * 60 * 1000 }
    );
  }

  function raw_importRss(rangeOverride) {
    const range = String(rangeOverride || "7").trim();
    raw_setBusyUI(true);

    const startTs = Date.now();
    raw_notice("busy", "â³ Ingesting RSSâ€¦\n(We will update when server responds.)");

    clearInterval(rawState.ingestTicker);
    rawState.ingestTicker = setInterval(() => {
      const secs = Math.round((Date.now() - startTs)/1000);
      R("raw-lastRefresh").textContent = `Ingestingâ€¦ ${secs}s`;
    }, 1000);

    raw_runRpc(
      "Ingesting RSS",
      (gs) => {
        if (range === "daily") gs.ui_importRSS_daily_v1();
        else if (range === "14") gs.ui_importRSS_14days_v1();
        else if (range === "30") gs.ui_importRSS_30days_v2();
        else if (range === "all") gs.ui_importRSS_all_v2();
        else gs.ui_importRSS_7days_v2();
      },
      (res) => {
        clearInterval(rawState.ingestTicker);
        rawState.ingestTicker = null;
        raw_setBusyUI(false);

        if (!res || res.ok !== true) {
          raw_notice("err", "âŒ Ingest failed.\n\nFULL RESPONSE:\n" + JSON.stringify(res, null, 2));
          R("raw-lastRefresh").textContent = "Failed";
          return;
        }

        const s = res.stats || {};
        const secs = Math.max(1, Math.round((Date.now() - startTs) / 1000));

        let msg =
          `âœ… Ingest complete (${secs}s)\n` +
          `${res.message}\n\n` +
          `Imported: ${s.imported || 0}\n` +
          `Duplicates skipped: ${s.skippedDuplicate || 0}\n` +
          `Old/invalid date skipped: ${s.skippedDate || 0}\n` +
          `No-match skipped: ${s.skippedNoMatch || 0}\n` +
          `Missing fields skipped: ${s.skippedMissingFields || 0}\n` +
          `Feed errors: ${s.feedErrors || 0}`;

        if (res.prune) {
          msg += `\nPruned (>${res.prune.maxAgeDays || 14} days): ${res.prune.removed || 0}`;
        }

        if (res.llm) {
          const llmStatus = String(res.llm.status || "done");
          const llmMeta = res.llm.meta || {};
          msg += `\nAI scoring: ${res.llm.message || llmStatus}`;
          if (Number(llmMeta.scored_total || 0) > 0 || Number(llmMeta.recommended_total || 0) > 0) {
            msg += `\nAI scored: ${llmMeta.scored_total || 0} | Recommended: ${llmMeta.recommended_total || 0}`;
          }
        }

        if (Array.isArray(res.errors) && res.errors.length) {
          msg += `\n\nErrors (first ${Math.min(10, res.errors.length)}):\n- ` +
                res.errors.slice(0, 10).join("\n- ");
        }

        raw_notice("ok", msg);
        R("raw-lastRefresh").textContent = "Ingested @ " + new Date().toLocaleTimeString();

        raw_bootstrap();
      },
      (err) => {
        clearInterval(rawState.ingestTicker);
        rawState.ingestTicker = null;
        raw_setBusyUI(false);

        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "âŒ Ingest RPC error:\n" + msg);
        R("raw-lastRefresh").textContent = "Failed";
      },
      { warnAfterMs: 35000, hardTimeoutMs: 6 * 60 * 1000 }
    );
  }

  function raw_runLlmScore(){
    raw_setBusyUI(true);
    raw_notice("busy", "ðŸ§  Running LLM scoring for unscored articles (full re-read enabled)â€¦\nPrompt source: " + (String((R("raw-llmPrompt")?.value || "")).trim() ? "custom/debug" : "default"));
    R("raw-lastRefresh").textContent = "LLM scoringâ€¦";
    raw_pollLlmScore();
  }

  function raw_pollLlmScore(){
    raw_runRpc(
      "LLM scoring",
      (gs) => gs.ui_runRawArticlesLlmRank_v2({ prompt: raw_getActivePrompt(), maxRows: 0, fetchText: true, sectorBy: "theme" }),
      (res) => {
        if (!res || res.ok !== true) {
          raw_setBusyUI(false);
          raw_notice("err", "âŒ LLM scoring failed:\n" + (res?.message || JSON.stringify(res, null, 2)));
          R("raw-lastRefresh").textContent = "LLM failed";
          return;
        }

        const scored = Number(res?.meta?.scored_total || 0);
        const total = Number(res?.meta?.total_rows || scored);
        const recommended = Number(res?.meta?.recommended_total || 0);
        const sectorBy = String(res?.meta?.sector_by || "theme");
        const sectorCurrent = String(res?.meta?.sector_current || "");
        const sectorCursor = Number(res?.meta?.sector_cursor || 0);
        const sectorTotal = Number(res?.meta?.sector_total || 0);

        if (res.status === "in_progress") {
          const sectorLine = sectorCurrent
            ? `\nSector (${sectorBy}): ${sectorCurrent} (${Math.min(sectorCursor + 1, sectorTotal)}/${sectorTotal || "?"})`
            : "";
          raw_notice("busy", `ðŸ§  LLM scoring in progressâ€¦\nScored ${scored} / ${total}${sectorLine}\nRecommended: ${recommended}`);
          R("raw-lastRefresh").textContent = `LLM scoringâ€¦ ${scored}/${total}`;
          setTimeout(raw_pollLlmScore, 700);
          return;
        }

        raw_setBusyUI(false);
        raw_notice("ok", `âœ… LLM scoring complete.\nScored total: ${scored}\nRecommended: ${recommended}`);
        R("raw-lastRefresh").textContent = "LLM done @ " + new Date().toLocaleTimeString();
        raw_bootstrap();
      },
      (err) => {
        raw_setBusyUI(false);
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "âŒ LLM scoring RPC error:\n" + msg);
        R("raw-lastRefresh").textContent = "LLM failed";
      },
      { warnAfterMs: 25000, hardTimeoutMs: 6 * 60 * 1000 }
    );
  }
</script>
