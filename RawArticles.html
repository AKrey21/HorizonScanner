<div id="raw-root" style="padding:12px;">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    /* ===== Layout: fill available height from index.html container ===== */
    #raw-root{
      --fs-bg:#071326;
      --fs-surface:#0d2247;
      --fs-surface-2:#132e5e;
      --fs-card:#102652;
      --fs-border:#2b4875;
      --fs-border-strong:#3a5a8d;
      --fs-shadow:0 18px 40px rgba(1,8,24,.35);
      --fs-shadow-soft:0 14px 28px rgba(1,8,24,.28);
      --fs-text:#f5f7ff;
      --fs-muted:#c5d0e6;
      --fs-muted-weak:#9aa8c8;
      --fs-placeholder:#8ea0c4;
      --fs-accent:#FF7300;
      --fs-accent-soft:rgba(255,115,0,.18);
      --fs-primary-soft:rgba(13,34,71,.85);
      --fs-header-bg:#0d2247;
      --fs-header-text:#f5f7ff;
      height:100%;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      color:var(--fs-text);
      background: radial-gradient(circle at top left, #0b1f42, var(--fs-bg) 55%);
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
    }

    .top-section{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .page-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--fs-border);
      background: linear-gradient(135deg, rgba(19,46,94,.95), rgba(9,24,52,.95));
      box-shadow: var(--fs-shadow-soft);
    }
    .page-title{
      font-size:18px;
      font-weight:600;
      letter-spacing:.2px;
    }
    .page-sub{
      font-size:12px;
      color:var(--fs-muted);
      margin-top:4px;
    }
    .head-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      color:var(--fs-muted);
      font-size:12px;
    }
    .stat-pill{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: rgba(15,33,69,.6);
      color:var(--fs-text);
    }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .controls.panel{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--fs-border);
      background: linear-gradient(180deg, rgba(13,34,71,.95), rgba(12,27,58,.95));
      box-shadow: var(--fs-shadow-soft);
    }
    .search{
      flex:1; min-width:240px;
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--fs-border-strong);
      background: rgba(9,26,56,.85);
      border-radius:999px; padding:10px 12px;
      color:var(--fs-text);
    }
    .search input{ border:0; outline:0; background:transparent; color:var(--fs-text); width:100%; font-size:13px; }
    .search .hint{ color:var(--fs-muted); font-size:11px; white-space:nowrap; }

    .btn, select, input[type="date"], input[type="text"]{
      border-radius:999px; border:1px solid var(--fs-border);
      background: rgba(19,46,94,.9);
      color:var(--fs-text);
      padding:10px 12px; font-size:12px;
      transition: all .15s ease;
    }
    select option{
      background: var(--fs-surface-2);
      color: var(--fs-text);
    }
    input::placeholder{ color: var(--fs-placeholder); }
    select:focus, input[type="date"]:focus, input[type="text"]:focus{
      outline:2px solid rgba(255,115,0,.35);
      outline-offset:1px;
    }
    .btn{ cursor:pointer; }
    .btn.primary{
      border-color: var(--fs-accent);
      background: var(--fs-accent);
      color: #1b1b1b;
    }
    .btn:not(.primary){
      background: var(--fs-surface-2);
      border-color: var(--fs-border);
      color: var(--fs-text);
    }
    .btn:not(.primary):hover{
      background: #17346a;
      border-color: var(--fs-border-strong);
    }
    .btn.ghost{ background: transparent; }
    .btn.mini{ padding:8px 10px; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .rightControls{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-left:auto;
    }

    .pill{
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--fs-border);
      background: var(--fs-surface-2);
      font-size: 11px;
      color:var(--fs-muted);
      white-space:nowrap;
    }

    .notice{
      border:1px solid var(--fs-border);
      background: var(--fs-surface);
      border-radius:14px;
      padding:10px 12px;
      color:var(--fs-text);
      font-size:12px;
      white-space:pre-wrap;
      display:none;
    }
    .notice.show{ display:block; }
    .notice.ok{ border-color: #2a4f8f; background: #122a56; }
    .notice.err{ border-color: #c3531a; background: #2a1a12; }
    .notice.busy{ border-color: #244377; background: #101f3f; }
    .notice.warn{ border-color: #b25d24; background: #2c1d12; }

    .summaryBar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      border:1px solid var(--fs-border);
      background: rgba(13,34,71,.92);
      border-radius:14px;
      padding:8px 10px;
      color:var(--fs-muted);
      font-size:12px;
    }
    .summaryBar b{ color:var(--fs-text); font-weight:600; }
    .spacer{ flex:1; }

    /* ===== Main stack: filters on top, articles below ===== */
    .main{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
.side{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:10px;
  align-items:start;
}
    .side .summaryBar{
      grid-column:1 / -1;
    }
    .content{
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Cards */
    .box{
      border:1px solid var(--fs-border);
      background: rgba(13,34,71,.92);
      border-radius:14px;
      padding:10px 12px;
      color:var(--fs-text);
      min-width:0;
      box-shadow: var(--fs-shadow-soft);
    }
    .boxHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .label{ font-size:11px; color:var(--fs-muted); margin-bottom:6px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1 1 160px; min-width: 160px; }
    .row.tight > *{ flex: 1 1 120px; min-width: 120px; }
    .row .mini{ flex: 0 0 auto; min-width: 0; }

    /* Chips */
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:2px 10px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: var(--fs-surface);
      color:var(--fs-text);
      font-size:11px;
      max-width: 100%;
    }
    .chip .x{ cursor:pointer; opacity:.75; font-weight:700; line-height:1; }
    .chip .x:hover{ opacity:1; }

    /* ===== Card list area ===== */
    .wrap{
      flex:1 1 auto;
      min-height:0;
      border:1px solid var(--fs-border);
      border-radius:14px;
      overflow:hidden; /* switched by JS depending on Fit screen */
      background: rgba(11,24,50,.9);
      box-shadow: var(--fs-shadow-soft);
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap:12px;
      padding:12px;
    }

    .card{
      border:1px solid var(--fs-border);
      background: linear-gradient(160deg, #0f2854, #0b1e3f);
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:220px;
      box-shadow: var(--fs-shadow);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow: 0 20px 45px rgba(1,8,24,.5);
      border-color: var(--fs-border-strong);
    }

    .card-media{
      height:120px;
      padding:12px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      background:
        radial-gradient(120px 80px at 20% 20%, rgba(255,115,0,.25), transparent 60%),
        radial-gradient(160px 120px at 80% 20%, rgba(245,247,255,.18), transparent 60%),
        linear-gradient(135deg, #0d234b, #081631);
      color:var(--fs-header-text);
    }

    .card-date{
      font-size:11px;
      letter-spacing:.3px;
      padding:4px 8px;
      border-radius:999px;
      background: #0b1e3f;
      border:1px solid var(--fs-border);
    }

    .card-body{
      padding:12px 14px 6px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .card-title{
      font-size:14px;
      font-weight:600;
      line-height:1.35;
    }

    .card-desc{
      font-size:12px;
      color:var(--fs-muted);
      line-height:1.4;
    }

    .card-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: #142f60;
      color:var(--fs-text);
      white-space:nowrap;
    }

    .card-footer{
      padding:0 14px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    a{ color:var(--fs-text); text-decoration:none; word-break:break-word; }
    a:hover{ text-decoration:underline; }

    .clickable{
      cursor:pointer;
      text-decoration: underline;
      text-decoration-color: rgba(15,23,42,.35);
      text-underline-offset: 2px;
    }

    .kw-pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--fs-border);
      background: var(--fs-surface-2);
      margin: 0 6px 6px 0;
      font-size: 11px;
      color:var(--fs-muted);
      white-space: nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pager{
      display:flex; gap:8px; align-items:center;
      color:var(--fs-muted); font-size:12px; flex-wrap: wrap;
    }

    .empty{
      padding:18px 14px;
      color:var(--fs-muted);
      font-size:12px;
      display:none;
    }

    .meta{
      color:var(--fs-muted);
      font-size:12px;
      letter-spacing:.2px;
    }

    .llmBadge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.3px;
      border:1px solid transparent;
    }
    .llmBadge--publish{
      background: rgba(37,130,80,.2);
      color:#baf7d4;
      border-color: rgba(37,130,80,.5);
    }
    .llmBadge--maybe{
      background: rgba(223,149,38,.18);
      color:#ffd9a1;
      border-color: rgba(223,149,38,.5);
    }
    .llmBadge--skip{
      background: rgba(196,73,73,.2);
      color:#ffc7c7;
      border-color: rgba(196,73,73,.5);
    }
    .llmBadge--unknown{
      background: rgba(255,255,255,.08);
      color:var(--fs-muted);
      border-color: rgba(255,255,255,.15);
    }

    .llmScore{
      font-weight:600;
    }

    .scoreBadge{
      position:absolute;
      top:10px;
      right:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      letter-spacing:.3px;
      background: rgba(8,18,40,.8);
      border:1px solid rgba(255,255,255,.2);
      color:var(--fs-text);
      backdrop-filter: blur(4px);
    }

    .scoreBadge span{
      color:var(--fs-accent);
      font-weight:800;
      margin-left:6px;
    }

    .card-media{
      position:relative;
      background-size:cover;
      background-position:center;
    }

    .card{
      cursor:pointer;
    }
    .card-details{
      display:none;
      border-top:1px solid var(--fs-border);
      background: rgba(8,18,38,.75);
      padding:10px 12px;
      font-size:12px;
      color:var(--fs-muted);
      line-height:1.45;
    }
    .card.expanded .card-details{ display:block; }
    .detail-title{ color:var(--fs-text); font-weight:600; margin-bottom:4px; }
    .detail-block{ margin-top:8px; }
    .reason-list{ margin:6px 0 0 18px; padding:0; }
    .reason-list li{ margin:3px 0; }

    /* Responsive */
    @media (max-width: 980px){
      .side{ grid-template-columns: 1fr; }
    }
  </style>

  <div class="top-section">
    <div class="page-head">
      <div>
        <div class="page-title">All Articles</div>
        <div class="page-sub">Unified view with LLM scoring + recommendations.</div>
      </div>
      <div class="head-actions">
        <span class="stat-pill">Live feed</span>
        <span class="stat-pill">Rapid filters</span>
      </div>
    </div>

    <!-- Top controls -->
    <div class="controls panel">
    <div class="search">
      <span style="opacity:.8;">üîé</span>
      <input id="raw-q" placeholder="Search across title/link/source/theme/poi/keywords..." />
      <span class="hint" id="raw-qHint"></span>
      <span class="pill" id="raw-lastRefresh" title="Last table refresh / ingest time">‚Äî</span>
    </div>

    <select id="raw-pageSize" title="Rows per page">
      <option value="fit" selected>Fit screen</option>
      <option value="25">25</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="200">200</option>
      <option value="500">500</option>
    </select>

    <button class="btn primary" onclick="raw_apply(true)">Apply</button>
    <button class="btn" onclick="raw_clear()">Clear</button>

      <div class="rightControls">
      <div class="label" style="margin-right:6px;">Ingest RSS:</div>
      <div class="row tight" style="flex-wrap:wrap;">
        <button class="btn" id="raw-import7Btn" onclick="raw_importRss('7')">Last 7 days</button>
        <button class="btn" id="raw-import30Btn" onclick="raw_importRss('30')">Last 30 days</button>
        <button class="btn" id="raw-importAllBtn" onclick="raw_importRss('all')">All time</button>
        <button class="btn primary" id="raw-importDailyBtn" onclick="raw_importRss('daily')">
          Daily (12:00 + prune 30d)
        </button>
        <button class="btn" id="raw-runLlmBtn" onclick="raw_runLlmScore()">Run LLM score (new only)</button>
      </div>
      <button class="btn" id="raw-refreshBtn" onclick="raw_bootstrap()">Refresh Table</button>
    </div>
    </div>
  </div>

  <!-- Split area -->
  <div class="main">
    <!-- Sidebar -->
    <div class="side">
      <div class="summaryBar" id="raw-summary">
        <span>Active filters: <b>none</b></span>
        <span class="spacer"></span>
        <span class="pill" id="raw-resultPill">‚Äî</span>
      </div>

      <div class="box">
        <div class="boxHead">
          <div class="label">Sort + Date range (optional)</div>
          <button class="btn ghost mini" onclick="raw_quickToday()">Today</button>
        </div>
        <div class="row">
          <select id="raw-sort">
            <option value="dateDesc">Date (newest)</option>
            <option value="dateAsc">Date (oldest)</option>
            <option value="sourceAsc">Source (A‚ÜíZ)</option>
            <option value="themeAsc">Theme (A‚ÜíZ)</option>
            <option value="poiAsc">POI (A‚ÜíZ)</option>
            <option value="titleAsc">Title (A‚ÜíZ)</option>
            <option value="llmScoreDesc" selected>LLM score (high ‚Üí low)</option>
          </select>
          <input id="raw-dateFrom" type="date" title="Date from"/>
          <input id="raw-dateTo" type="date" title="Date to"/>
        </div>
        <div class="row" style="margin-top:6px;">
          <label class="chk" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="raw-llmRecOnly"/>
            LLM recommended only
          </label>
          <span class="pill">Uses latest LLM rank cache</span>
        </div>
        <div class="label" style="margin-top:8px;">Tip: click Theme/Source/POI in cards to quick-filter</div>
      </div>

      <div class="box">
        <div class="label">Facets (type to search ‚Üí Add)</div>

        <div class="label" style="margin-top:6px;">Theme</div>
        <div class="row tight">
          <input id="raw-themeAdd" type="text" list="raw-themeList" placeholder="e.g. Future of Work" />
          <button class="btn mini" onclick="raw_addFacet('theme')">Add</button>
        </div>
        <datalist id="raw-themeList"></datalist>
        <div class="chips" id="raw-themeChips"></div>

        <div class="label" style="margin-top:10px;">Point of Interest</div>
        <div class="row tight">
          <input id="raw-poiAdd" type="text" list="raw-poiList" placeholder="e.g. Jobs/ Employment..." />
          <button class="btn mini" onclick="raw_addFacet('poi')">Add</button>
        </div>
        <datalist id="raw-poiList"></datalist>
        <div class="chips" id="raw-poiChips"></div>

        <div class="label" style="margin-top:10px;">Source</div>
        <div class="row tight">
          <input id="raw-sourceAdd" type="text" list="raw-sourceList" placeholder="e.g. BBC" />
          <button class="btn mini" onclick="raw_addFacet('source')">Add</button>
        </div>
        <datalist id="raw-sourceList"></datalist>
        <div class="chips" id="raw-sourceChips"></div>
      </div>

      <div class="box">
        <div class="label">Keyword filters</div>

        <div class="row" style="margin-top:6px;">
          <div class="label" style="margin:0;">Include mode</div>
          <select id="raw-kwMode" style="min-width:140px; flex:0 0 auto;">
            <option value="any" selected>ANY</option>
            <option value="all">ALL</option>
          </select>
        </div>

        <div class="label" style="margin-top:6px;">Include</div>
        <div class="row tight">
          <input id="raw-kwIncAdd" type="text" list="raw-kwList" placeholder="e.g. layoffs" />
          <button class="btn mini" onclick="raw_addFacet('kwInc')">Add</button>
        </div>
        <div class="chips" id="raw-kwIncChips"></div>

        <div class="label" style="margin-top:10px;">Exclude</div>
        <div class="row tight">
          <input id="raw-kwExcAdd" type="text" list="raw-kwList" placeholder="e.g. crypto" />
          <button class="btn mini" onclick="raw_addFacet('kwExc')">Add</button>
        </div>
        <datalist id="raw-kwList"></datalist>
        <div class="chips" id="raw-kwExcChips"></div>
      </div>

    </div>

    <!-- Table/content -->
    <div class="content">
      <div class="meta" id="raw-meta">Loading‚Ä¶</div>

      <div class="wrap" id="raw-wrap">
        <div class="cards" id="raw-cards"></div>
        <div class="empty" id="raw-empty">No results. Try clearing some filters.</div>
      </div>

      <div class="pager">
        <button class="btn" id="raw-prev" onclick="raw_prev()">‚óÄ Prev</button>
        <span id="raw-pageInfo">Page ‚Äî</span>
        <button class="btn" id="raw-next" onclick="raw_next()">Next ‚ñ∂</button>
        <span class="pill" id="raw-showing" title="Rows shown on this page">‚Äî</span>
      </div>
    </div>
  </div>

  <div class="notice" id="raw-notice"></div>
</div>

<script>
  window.__init_raw = function() { raw_bootstrap(); };

  let rawState = {
    rpcSeq: 0,
    ingestTicker: null,

    boot: null,
    allRows: [],
    filtered: [],

    page: 1,
    pageSize: 25,

    selTheme: new Set(),
    selPoi: new Set(),
    selSource: new Set(),
    selKwInc: new Set(),
    selKwExc: new Set(),
    expandedIds: new Set(),

    rowH: 56 // used for Fit screen estimate; refined after render
  };

  const RAW_LLM_DEFAULT_PROMPT = "Score each article for executive horizon-scanning relevance and set publish_recommendation to publish, maybe, or skip.";

  const R = (id) => document.getElementById(id);

  function raw_notice(type, msg){
    const box = R("raw-notice");
    box.className = "notice show " + (type || "");
    box.textContent = msg || "";
  }
  function raw_noticeClear(){
    const box = R("raw-notice");
    box.className = "notice";
    box.textContent = "";
  }

  function raw_escape(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function raw_buildThumb(link){
    const clean = String(link || "").trim();
    if (!clean) return "";
    return "https://image.thum.io/get/width/600/crop/600/" + clean;
  }
  function raw_attr(str){ return encodeURIComponent(String(str || "")); }
  function raw_unattr(str){ try { return decodeURIComponent(String(str||"")); } catch(e){ return String(str||""); } }
  function raw_setBusyUI(isBusy){
    ["raw-import7Btn","raw-import30Btn","raw-importAllBtn","raw-importDailyBtn","raw-runLlmBtn"].forEach(id => {
      const btn = R(id);
      if (btn) btn.disabled = !!isBusy;
    });
    R("raw-refreshBtn").disabled = !!isBusy;
  }

  function raw_runRpc(label, invokeFn, onSuccess, onFailure, opts){
    opts = opts || {};
    const warnAfterMs = Number(opts.warnAfterMs || 15000);
    const hardTimeoutMs = Number(opts.hardTimeoutMs || 120000);

    const seq = ++rawState.rpcSeq;
    const start = Date.now();

    const warnTimer = setTimeout(() => {
      if (seq !== rawState.rpcSeq) return;
      raw_notice("warn", `‚è≥ ${label} is still running‚Ä¶ Elapsed: ${Math.round((Date.now()-start)/1000)}s`);
      R("raw-lastRefresh").textContent = "Running‚Ä¶";
    }, warnAfterMs);

    const hardTimer = setTimeout(() => {
      if (seq !== rawState.rpcSeq) return;
      raw_notice("err",
        `‚ö†Ô∏è ${label} is taking unusually long.\n` +
        `Elapsed: ${Math.round((Date.now()-start)/1000)}s\n\n` +
        `Check Apps Script ‚Üí Executions for errors/timeouts.`
      );
      R("raw-lastRefresh").textContent = "Timed out";
    }, hardTimeoutMs);

    const gs = google.script.run
      .withSuccessHandler((res) => {
        if (seq !== rawState.rpcSeq) return;
        clearTimeout(warnTimer);
        clearTimeout(hardTimer);
        onSuccess(res);
      })
      .withFailureHandler((err) => {
        if (seq !== rawState.rpcSeq) return;
        clearTimeout(warnTimer);
        clearTimeout(hardTimer);
        onFailure(err);
      });

    invokeFn(gs);
  }

  // ----- chips helpers -----
  function raw_addToSet(setObj, value){
    const v = String(value || "").trim();
    if (!v) return;
    setObj.add(v);
  }
  function raw_removeFromSet(setObj, value){ setObj.delete(value); }

  function raw_renderChips(setObj, chipsElId, onRemove){
    const el = R(chipsElId);
    const arr = Array.from(setObj.values());
    el.innerHTML = arr.map(v => `
      <span class="chip">
        <span>${raw_escape(v)}</span>
        <span class="x" data-v="${raw_attr(v)}">√ó</span>
      </span>
    `).join("");

    el.querySelectorAll(".x").forEach(x => {
      x.addEventListener("click", () => {
        const v = raw_unattr(x.getAttribute("data-v"));
        onRemove(v);
      });
    });
  }

  function raw_renderAllChips(){
    raw_renderChips(rawState.selTheme, "raw-themeChips", (v)=>{ raw_removeFromSet(rawState.selTheme,v); raw_apply(true); });
    raw_renderChips(rawState.selPoi, "raw-poiChips", (v)=>{ raw_removeFromSet(rawState.selPoi,v); raw_apply(true); });
    raw_renderChips(rawState.selSource, "raw-sourceChips", (v)=>{ raw_removeFromSet(rawState.selSource,v); raw_apply(true); });
    raw_renderChips(rawState.selKwInc, "raw-kwIncChips", (v)=>{ raw_removeFromSet(rawState.selKwInc,v); raw_apply(true); });
    raw_renderChips(rawState.selKwExc, "raw-kwExcChips", (v)=>{ raw_removeFromSet(rawState.selKwExc,v); raw_apply(true); });
  }

  function raw_fillDatalist(listId, facets){
    const dl = R(listId);
    dl.innerHTML = "";
    (facets || []).forEach(it => {
      const opt = document.createElement("option");
      opt.value = it.value;
      opt.label = it.count ? `${it.value} (${it.count})` : it.value;
      dl.appendChild(opt);
    });
  }

  function raw_parseDateInputMs(id, endOfDay){
    const v = (R(id).value || "").trim();
    if (!v) return null;
    const d = new Date(v + "T00:00:00");
    if (endOfDay) d.setHours(23,59,59,999);
    const t = d.getTime();
    return isNaN(t) ? null : t;
  }

  function raw_addFacet(kind){
    const map = {
      theme: { input:"raw-themeAdd", set: rawState.selTheme, norm: (s)=>String(s||"").trim() },
      poi:   { input:"raw-poiAdd", set: rawState.selPoi, norm: (s)=>String(s||"").trim() },
      source:{ input:"raw-sourceAdd", set: rawState.selSource, norm: (s)=>String(s||"").trim() },
      kwInc: { input:"raw-kwIncAdd", set: rawState.selKwInc, norm: (s)=>String(s||"").trim().toLowerCase() },
      kwExc: { input:"raw-kwExcAdd", set: rawState.selKwExc, norm: (s)=>String(s||"").trim().toLowerCase() },
    };
    const cfg = map[kind];
    if (!cfg) return;

    const valRaw = (R(cfg.input).value || "");
    const val = cfg.norm(valRaw);
    if (!val) return;

    raw_addToSet(cfg.set, val);
    R(cfg.input).value = "";
    raw_renderAllChips();
    raw_apply(true);
  }

  function raw_computeFitPageSize(){
    const wrap = R("raw-wrap");
    const cardsEl = R("raw-cards");
    if (!wrap || !cardsEl) return 25;

    const h = wrap.clientHeight || 0;
    const usable = Math.max(120, h - 14);

    const styles = window.getComputedStyle(cardsEl);
    const gap = Number.parseFloat(styles.rowGap || styles.gap || "12") || 12;

    let columns = 1;
    const templateCols = String(styles.gridTemplateColumns || "").trim();
    if (templateCols && templateCols !== "none") {
      columns = Math.max(1, templateCols.split(/\s+/).filter(Boolean).length);
    }

    if (columns === 1) {
      const minCardWidth = 280;
      const containerW = cardsEl.clientWidth || 0;
      if (containerW > 0) {
        columns = Math.max(1, Math.floor((containerW + gap) / (minCardWidth + gap)));
      }
    }

    const firstCard = cardsEl.querySelector(".card");
    const cardH = Math.max(
      80,
      Number(firstCard?.offsetHeight || rawState.rowH || 220)
    );

    const rowsFit = Math.max(1, Math.floor((usable + gap) / (cardH + gap)));
    return Math.max(1, rowsFit * columns);
  }

  function raw_getSelectedPageSize(){
    const v = (R("raw-pageSize").value || "50").trim();
    if (v === "fit") return raw_computeFitPageSize();
    const n = Number(v);
    return (isFinite(n) && n > 0) ? n : 50;
  }

  function raw_syncWrapOverflow(){
    const v = (R("raw-pageSize").value || "").trim();
    // If Fit screen, we aim for no table scroll (pagination only)
    R("raw-wrap").style.overflow = (v === "fit") ? "hidden" : "auto";
  }

  function raw_bootstrap(){
    raw_notice("busy", "üîÑ Loading table‚Ä¶");

    raw_runRpc(
      "Loading table",
      (gs) => gs.ui_getRawArticles_bootstrap_v1(),
      (res) => {
        if (!res || !res.ok) {
          raw_notice("err", "‚ùå Failed:\n" + (res?.message || JSON.stringify(res, null, 2)));
          return;
        }

        rawState.boot = res;
        const incomingRows = Array.isArray(res.rows) ? res.rows : [];
        rawState.allRows = incomingRows.map(r => {
          const row = (r && typeof r === "object") ? r : {};
          const title = String(row.title || "");
          const link = String(row.link || "");
          const source = String(row.source || "");
          const theme = String(row.theme || "");
          const poi = String(row.poi || "");
          const keywords = String(row.keywords || "");
          const llmRecommendation = String(row.llmRecommendation || "");
          const llmSummary = String(row.llmSummary || "");
          const llmReasons = Array.isArray(row.llmReasons) ? row.llmReasons.map(x => String(x || "").trim()).filter(Boolean) : [];
          return Object.assign({
            title,
            link,
            source,
            theme,
            poi,
            keywords,
            keywordsList: Array.isArray(row.keywordsList) ? row.keywordsList : [],
            llmScore: Number.isFinite(Number(row.llmScore)) ? Number(row.llmScore) : null,
            llmRecommendation,
            llmSummary,
            llmReasons,
            llmRecommended: !!row.llmRecommended,
            searchText: (title + " " + link + " " + source + " " + theme + " " + poi + " " + keywords + " " + llmRecommendation + " " + llmSummary + " " + llmReasons.join(" ")).toLowerCase()
          }, row);
        });
        rawState.page = 1;

        raw_fillDatalist("raw-themeList",  res.facets?.themes || []);
        raw_fillDatalist("raw-poiList",    res.facets?.pois || []);
        raw_fillDatalist("raw-sourceList", res.facets?.sources || []);
        raw_fillDatalist("raw-kwList",     res.facets?.keywords || []);

        raw_renderAllChips();
        raw_apply(true);
      },
      (err) => {
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "‚ùå Table load error:\n" + msg);
      },
      { warnAfterMs: 15000, hardTimeoutMs: 120000 }
    );
  }

  function raw_apply(resetToFirstPage){
    if (resetToFirstPage) rawState.page = 1;

    raw_syncWrapOverflow();

    rawState.pageSize = raw_getSelectedPageSize();
    const q = (R("raw-q").value || "").trim().toLowerCase();
    R("raw-qHint").textContent = q ? "Press Enter to apply faster" : "";

    const fromMs = raw_parseDateInputMs("raw-dateFrom", false);
    const toMs   = raw_parseDateInputMs("raw-dateTo", true);

    const themes = rawState.selTheme;
    const pois   = rawState.selPoi;
    const sources= rawState.selSource;
    const kwInc  = rawState.selKwInc;
    const kwExc  = rawState.selKwExc;
    const kwMode = (R("raw-kwMode").value || "any");
    const llmRecOnly = !!R("raw-llmRecOnly").checked;

    let filtered = [];
    try {
      filtered = rawState.allRows.filter(r => {
        if (themes.size && !themes.has(r.theme)) return false;
        if (pois.size && !pois.has(r.poi)) return false;
        if (sources.size && !sources.has(r.source)) return false;

        if (fromMs && r.dateMs && r.dateMs < fromMs) return false;
        if (toMs && r.dateMs && r.dateMs > toMs) return false;

        const klist = (r.keywordsList || []);

        if (kwInc.size) {
          if (kwMode === "all") {
            let okAll = true;
            kwInc.forEach(k => { if (!klist.includes(k)) okAll = false; });
            if (!okAll) return false;
          } else {
            let okAny = false;
            kwInc.forEach(k => { if (klist.includes(k)) okAny = true; });
            if (!okAny) return false;
          }
        }

        if (kwExc.size) {
          let bad = false;
          kwExc.forEach(k => { if (klist.includes(k)) bad = true; });
          if (bad) return false;
        }

        if (q) {
          if (!r.searchText || !r.searchText.includes(q)) return false;
        }
        if (llmRecOnly && !r.llmRecommended) return false;
        return true;
      });
    } catch (err) {
      raw_notice("err", "‚ùå Filter error:\n" + (err?.message || String(err)));
      filtered = [];
    }

    // sort
    const sv = (R("raw-sort").value || "dateDesc");
    const cmpStr = (a,b) => String(a||"").localeCompare(String(b||""));
    if (sv === "dateDesc") filtered.sort((a,b)=> (b.dateMs||0) - (a.dateMs||0));
    if (sv === "dateAsc")  filtered.sort((a,b)=> (a.dateMs||0) - (b.dateMs||0));
    if (sv === "sourceAsc")filtered.sort((a,b)=> cmpStr(a.source,b.source));
    if (sv === "themeAsc") filtered.sort((a,b)=> cmpStr(a.theme,b.theme));
    if (sv === "poiAsc")   filtered.sort((a,b)=> cmpStr(a.poi,b.poi));
    if (sv === "titleAsc") filtered.sort((a,b)=> cmpStr(a.title,b.title));
    if (sv === "llmScoreDesc") filtered.sort((a,b)=> (Number(b.llmScore || -1) - Number(a.llmScore || -1)));
    rawState.filtered = filtered;

    raw_updateSummary();
    raw_renderPage();
  }

  function raw_updateSummary(){
    const parts = [];
    if (rawState.selTheme.size)  parts.push(`Theme: ${rawState.selTheme.size}`);
    if (rawState.selPoi.size)    parts.push(`POI: ${rawState.selPoi.size}`);
    if (rawState.selSource.size) parts.push(`Source: ${rawState.selSource.size}`);
    if (rawState.selKwInc.size)  parts.push(`Include: ${rawState.selKwInc.size} (${(R("raw-kwMode").value||"any").toUpperCase()})`);
    if (rawState.selKwExc.size)  parts.push(`Exclude: ${rawState.selKwExc.size}`);
    if (R("raw-llmRecOnly").checked) parts.push("LLM recommended");
    if ((R("raw-dateFrom").value||"") || (R("raw-dateTo").value||"")) parts.push("Date range");
    if ((R("raw-q").value||"").trim()) parts.push("Search");
    R("raw-summary").querySelector("span").innerHTML =
      parts.length ? `Active filters: <b>${raw_escape(parts.join(" ‚Ä¢ "))}</b>` : `Active filters: <b>none</b>`;

    R("raw-resultPill").textContent = `Results: ${rawState.filtered.length}`;
  }

  function raw_renderPage(){
    const total = rawState.filtered.length;
    const pageSize = rawState.pageSize;
    const maxPage = Math.max(1, Math.ceil(total / pageSize));
    rawState.page = Math.min(rawState.page, maxPage);

    const start = (rawState.page - 1) * pageSize;
    const slice = rawState.filtered.slice(start, start + pageSize);

    R("raw-pageInfo").textContent = `Page ${rawState.page} / ${maxPage}`;
    R("raw-prev").disabled = (rawState.page <= 1);
    R("raw-next").disabled = (rawState.page >= maxPage);

    const sheet = rawState.boot?.sheet || "Raw Articles";
    const grandTotal = rawState.boot?.meta?.total || rawState.allRows.length;

    R("raw-meta").textContent = `Sheet: ${sheet} ‚Ä¢ Total: ${grandTotal} ‚Ä¢ Filtered: ${total} ‚Ä¢ Rows/page: ${pageSize}`;
    R("raw-showing").textContent = `Showing: ${slice.length}`;
    R("raw-lastRefresh").textContent = "Updated @ " + new Date().toLocaleTimeString();

    const empty = R("raw-empty");
    empty.style.display = total ? "none" : "block";

    const cards = slice.map(r => {
      const title = raw_escape(r.title || "");
      const link = (r.link || "").trim();
      const dateLabel = raw_escape(r.dateDisplay || "No date");
      const titleHtml = link
        ? `<a href="${raw_escape(link)}" target="_blank" rel="noopener noreferrer">${title}</a>`
        : title;

      const srcRaw = String(r.source || "");
      const thmRaw = String(r.theme || "");
      const poiRaw = String(r.poi || "");

      const kws = (r.keywordsList || []).slice(0, 8)
        .map(k => `<span class="kw-pill" title="${raw_escape(k)}">${raw_escape(k)}</span>`).join("");

      const tag = (kind, value) => value
        ? `<span class="tag clickable" data-kind="${kind}" data-v="${raw_attr(value)}">${raw_escape(value)}</span>`
        : "‚Äî";

      const llmScore = Number.isFinite(Number(r.llmScore)) ? Number(r.llmScore).toFixed(1) : "‚Äî";
      const recRaw = String(r.llmRecommendation || "").trim();
      const recNorm = recRaw ? recRaw.toLowerCase() : "unknown";
      const recClass = recNorm === "publish" ? "publish" : (recNorm === "maybe" ? "maybe" : (recNorm === "skip" ? "skip" : "unknown"));
      const recLabel = recRaw || "Unknown";
      const thumb = raw_buildThumb(link);
      const mediaStyle = thumb
        ? `style="background-image: linear-gradient(135deg, rgba(6,16,36,.85), rgba(6,16,36,.4)), url('${raw_escape(thumb)}')"`
        : `style="background-image: linear-gradient(135deg, rgba(6,16,36,.9), rgba(6,16,36,.6))"`;

      const descParts = [];
      if (srcRaw) descParts.push(`Source: ${raw_escape(srcRaw)}`);
      if (thmRaw) descParts.push(`Theme: ${raw_escape(thmRaw)}`);
      if (poiRaw) descParts.push(`POI: ${raw_escape(poiRaw)}`);
      const desc = descParts.length ? descParts.join(" ‚Ä¢ ") : "No category tags available yet.";

      const articleId = Number(r.id || 0);
      const isExpanded = rawState.expandedIds.has(articleId);
      const reasonItems = (r.llmReasons || []).map(x => `<li>${raw_escape(x)}</li>`).join("");
      const summaryText = String(r.llmSummary || "").trim();
      const recommendationLabel = recClass === "publish" ? "Yes" : (recClass === "maybe" ? "Maybe" : "No");
      const allKeywords = (r.keywordsList || []).map(k => `<span class="kw-pill" title="${raw_escape(k)}">${raw_escape(k)}</span>`).join("");

      return `
        <article class="card ${isExpanded ? "expanded" : ""}" data-id="${articleId}">
          <div class="card-media" ${mediaStyle}>
            <span class="card-date">${dateLabel}</span>
            <div class="scoreBadge">LLM<span>${llmScore}</span></div>
          </div>
          <div class="card-body">
            <div class="card-title">${titleHtml}</div>
            <div class="card-desc">${desc}</div>
            <div class="card-tags">
              ${tag("source", srcRaw)}
              ${tag("theme", thmRaw)}
              ${tag("poi", poiRaw)}
              <span class="llmBadge llmBadge--${recClass}">${raw_escape(recLabel)}</span>
            </div>
          </div>
          <div class="card-footer">
            ${kws}
          </div>
          <div class="card-details">
            <div class="detail-title">Recommendation: ${recommendationLabel} (${raw_escape(recLabel)})</div>
            <div><b>Why:</b> ${(reasonItems ? `<ul class="reason-list">${reasonItems}</ul>` : "No LLM reasons recorded yet.")}</div>
            <div class="detail-block"><b>Summary:</b> ${summaryText ? raw_escape(summaryText) : "No summary available yet."}</div>
            <div class="detail-block"><b>All keyword tags:</b> ${allKeywords || "‚Äî"}</div>
          </div>
        </article>
      `;
    }).join("");

    R("raw-cards").innerHTML = cards;

    const firstCard = R("raw-cards")?.querySelector(".card");
    if (firstCard && firstCard.offsetHeight) rawState.rowH = firstCard.offsetHeight;

    raw_noticeClear();
  }

  function raw_clear(){
    R("raw-q").value = "";
    R("raw-dateFrom").value = "";
    R("raw-dateTo").value = "";
    R("raw-sort").value = "llmScoreDesc";
    R("raw-kwMode").value = "any";
    R("raw-llmRecOnly").checked = false;

    rawState.selTheme.clear();
    rawState.selPoi.clear();
    rawState.selSource.clear();
    rawState.selKwInc.clear();
    rawState.selKwExc.clear();

    raw_renderAllChips();
    raw_apply(true);
  }

  function raw_prev(){ if (rawState.page > 1) { rawState.page--; raw_renderPage(); } }
  function raw_next(){
    const maxPage = Math.max(1, Math.ceil(rawState.filtered.length / rawState.pageSize));
    if (rawState.page < maxPage) { rawState.page++; raw_renderPage(); }
  }

  function raw_quickToday(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const iso = `${y}-${m}-${day}`;
    R("raw-dateFrom").value = iso;
    R("raw-dateTo").value = iso;
    raw_apply(true);
  }

  // quick-filter tags + card expand on click
  R("raw-cards").addEventListener("click", (e) => {
    const t = e.target;
    if (!t) return;

    if (t.closest("a")) return;

    const chip = t.closest(".clickable");
    if (chip && chip.dataset) {
      const kind = chip.dataset.kind;
      const v = raw_unattr(chip.dataset.v || "");
      if (!v) return;

      if (kind === "theme") raw_addToSet(rawState.selTheme, v);
      if (kind === "poi") raw_addToSet(rawState.selPoi, v);
      if (kind === "source") raw_addToSet(rawState.selSource, v);

      raw_renderAllChips();
      raw_apply(true);
      return;
    }

    const card = t.closest(".card");
    if (!card) return;
    const id = Number(card.getAttribute("data-id") || 0);
    if (!id) return;

    if (rawState.expandedIds.has(id)) rawState.expandedIds.delete(id);
    else rawState.expandedIds.add(id);

    raw_renderPage();
  });

  // Search debounce (fast)
  R("raw-q").addEventListener("input", () => {
    clearTimeout(window.__rawQTimer);
    window.__rawQTimer = setTimeout(() => raw_apply(true), 180);
  });

  // Changes trigger apply
  ["raw-pageSize","raw-sort","raw-dateFrom","raw-dateTo","raw-kwMode"].forEach(id => {
    R(id).addEventListener("change", () => raw_apply(true));
  });
  R("raw-llmRecOnly").addEventListener("change", () => raw_apply(true));

  // Fit screen: refresh on resize (debounced)
  window.addEventListener("resize", () => {
    clearTimeout(window.__rawResizeT);
    window.__rawResizeT = setTimeout(() => {
      if ((R("raw-pageSize").value || "") === "fit") raw_apply(true);
    }, 200);
  });

  // Enter key = quick apply + also add chips when focused on facet inputs
  document.addEventListener("keydown", (e) => {
    const el = document.activeElement;
    if (e.key !== "Enter") return;

    if (el === R("raw-q")) { raw_apply(true); return; }
    if (el === R("raw-themeAdd")) { raw_addFacet("theme"); return; }
    if (el === R("raw-poiAdd")) { raw_addFacet("poi"); return; }
    if (el === R("raw-sourceAdd")) { raw_addFacet("source"); return; }
    if (el === R("raw-kwIncAdd")) { raw_addFacet("kwInc"); return; }
    if (el === R("raw-kwExcAdd")) { raw_addFacet("kwExc"); return; }
  });

  function raw_importRss(rangeOverride) {
    const range = String(rangeOverride || "7").trim();
    raw_setBusyUI(true);

    const startTs = Date.now();
    raw_notice("busy", "‚è≥ Ingesting RSS‚Ä¶\n(We will update when server responds.)");

    clearInterval(rawState.ingestTicker);
    rawState.ingestTicker = setInterval(() => {
      const secs = Math.round((Date.now() - startTs)/1000);
      R("raw-lastRefresh").textContent = `Ingesting‚Ä¶ ${secs}s`;
    }, 1000);

    raw_runRpc(
      "Ingesting RSS",
      (gs) => {
        if (range === "daily") gs.ui_importRSS_daily_v1();
        else if (range === "30") gs.ui_importRSS_30days_v2();
        else if (range === "all") gs.ui_importRSS_all_v2();
        else gs.ui_importRSS_7days_v2();
      },
      (res) => {
        clearInterval(rawState.ingestTicker);
        rawState.ingestTicker = null;
        raw_setBusyUI(false);

        if (!res || res.ok !== true) {
          raw_notice("err", "‚ùå Ingest failed.\n\nFULL RESPONSE:\n" + JSON.stringify(res, null, 2));
          R("raw-lastRefresh").textContent = "Failed";
          return;
        }

        const s = res.stats || {};
        const secs = Math.max(1, Math.round((Date.now() - startTs) / 1000));

        let msg =
          `‚úÖ Ingest complete (${secs}s)\n` +
          `${res.message}\n\n` +
          `Imported: ${s.imported || 0}\n` +
          `Duplicates skipped: ${s.skippedDuplicate || 0}\n` +
          `Old/invalid date skipped: ${s.skippedDate || 0}\n` +
          `No-match skipped: ${s.skippedNoMatch || 0}\n` +
          `Missing fields skipped: ${s.skippedMissingFields || 0}\n` +
          `Feed errors: ${s.feedErrors || 0}`;

        if (res.prune) {
          msg += `\nPruned (>30 days): ${res.prune.removed || 0}`;
        }

        if (Array.isArray(res.errors) && res.errors.length) {
          msg += `\n\nErrors (first ${Math.min(10, res.errors.length)}):\n- ` +
                res.errors.slice(0, 10).join("\n- ");
        }

        raw_notice("ok", msg);
        R("raw-lastRefresh").textContent = "Ingested @ " + new Date().toLocaleTimeString();

        raw_bootstrap();
      },
      (err) => {
        clearInterval(rawState.ingestTicker);
        rawState.ingestTicker = null;
        raw_setBusyUI(false);

        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "‚ùå Ingest RPC error:\n" + msg);
        R("raw-lastRefresh").textContent = "Failed";
      },
      { warnAfterMs: 35000, hardTimeoutMs: 6 * 60 * 1000 }
    );
  }

  function raw_runLlmScore(){
    raw_setBusyUI(true);
    raw_notice("busy", "üß† Running LLM scoring for unscored articles‚Ä¶");
    R("raw-lastRefresh").textContent = "LLM scoring‚Ä¶";
    raw_pollLlmScore();
  }

  function raw_pollLlmScore(){
    raw_runRpc(
      "LLM scoring",
      (gs) => gs.ui_runRawArticlesLlmRank_v2({ prompt: RAW_LLM_DEFAULT_PROMPT, maxRows: 0, fetchText: false, sectorBy: "theme" }),
      (res) => {
        if (!res || res.ok !== true) {
          raw_setBusyUI(false);
          raw_notice("err", "‚ùå LLM scoring failed:\n" + (res?.message || JSON.stringify(res, null, 2)));
          R("raw-lastRefresh").textContent = "LLM failed";
          return;
        }

        const scored = Number(res?.meta?.scored_total || 0);
        const total = Number(res?.meta?.total_rows || scored);
        const recommended = Number(res?.meta?.recommended_total || 0);
        const sectorBy = String(res?.meta?.sector_by || "theme");
        const sectorCurrent = String(res?.meta?.sector_current || "");
        const sectorCursor = Number(res?.meta?.sector_cursor || 0);
        const sectorTotal = Number(res?.meta?.sector_total || 0);

        if (res.status === "in_progress") {
          const sectorLine = sectorCurrent
            ? `\nSector (${sectorBy}): ${sectorCurrent} (${Math.min(sectorCursor + 1, sectorTotal)}/${sectorTotal || "?"})`
            : "";
          raw_notice("busy", `üß† LLM scoring in progress‚Ä¶\nScored ${scored} / ${total}${sectorLine}\nRecommended: ${recommended}`);
          R("raw-lastRefresh").textContent = `LLM scoring‚Ä¶ ${scored}/${total}`;
          setTimeout(raw_pollLlmScore, 700);
          return;
        }

        raw_setBusyUI(false);
        raw_notice("ok", `‚úÖ LLM scoring complete.\nScored total: ${scored}\nRecommended: ${recommended}`);
        R("raw-lastRefresh").textContent = "LLM done @ " + new Date().toLocaleTimeString();
        raw_bootstrap();
      },
      (err) => {
        raw_setBusyUI(false);
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err, null, 2));
        raw_notice("err", "‚ùå LLM scoring RPC error:\n" + msg);
        R("raw-lastRefresh").textContent = "LLM failed";
      },
      { warnAfterMs: 25000, hardTimeoutMs: 6 * 60 * 1000 }
    );
  }
</script>
