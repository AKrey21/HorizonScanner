<div id="feeds-root" style="padding:12px;">
  <style>
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    .search{
      flex:1; min-width:220px;
      display:flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius:999px; padding:10px 12px;
      color:#e8eaf0;
    }
    .search input{ border:0; outline:0; background:transparent; color:#e8eaf0; width:100%; font-size:13px; }

    .btn, select{
      border-radius:999px; border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:#e8eaf0;
      padding:10px 12px; font-size:12px;
    }
    .btn{ cursor:pointer; }
    .btn.primary{ border-color: rgba(122,162,255,.45); background: rgba(122,162,255,.16); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .meta{ color:#a7afc0; font-size:12px; margin-bottom:8px; }

    .wrap{ border:1px solid rgba(255,255,255,.08); border-radius:16px; overflow:auto; max-height:72vh; box-shadow:0 16px 40px rgba(0,0,0,.25); }
    table{ width:100%; border-collapse:collapse; font-size:12px; min-width:900px; }
    thead th{
      position:sticky; top:0; z-index:2;
      background: rgba(17,21,34,.90);
      color:#a7afc0; font-weight:600;
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px;
      text-align:left;
      white-space: nowrap;
    }
    tbody td{ border-bottom:1px solid rgba(255,255,255,.06); padding:10px; vertical-align:top; }
    tbody tr:nth-child(2n) td{ background: rgba(255,255,255,.02); }
    tbody tr.group-row td{
      background: rgba(122,162,255,.12);
      color:#e8eaf0;
      font-weight:600;
      border-bottom:1px solid rgba(122,162,255,.30);
      position:sticky;
      top:32px;
      z-index:1;
    }
    .group-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .group-title small{
      color:#c9d1e3;
      font-weight:500;
      opacity:.85;
    }

    input[type="text"], input[type="url"]{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:#e8eaf0;
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      outline:none;
    }
    input[type="text"]:focus, input[type="url"]:focus{
      border-color: rgba(122,162,255,.45);
      box-shadow:0 0 0 2px rgba(122,162,255,.20);
    }

    a{ color:#7aa2ff; text-decoration:none; word-break:break-all; }
    a:hover{ text-decoration:underline; }

    .pager{ display:flex; gap:8px; align-items:center; margin-top:10px; color:#a7afc0; font-size:12px; flex-wrap: wrap; }
    .pill{
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-size: 11px;
      color:#a7afc0;
    }

    .notice{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px 12px;
      color:#e8eaf0;
      font-size:12px;
      white-space:pre-wrap;
      display:none;
    }
    .notice.show{ display:block; }
    .notice.ok{  border-color: rgba(122,255,170,.30); background: rgba(122,255,170,.10); }
    .notice.err{ border-color: rgba(255,120,120,.35); background: rgba(255,120,120,.12); }
    .notice.busy{border-color: rgba(122,162,255,.35); background: rgba(122,162,255,.10); }
    .source-badge{
      padding:2px 8px;
      border-radius:999px;
      background: rgba(17,21,34,.55);
      border:1px solid rgba(255,255,255,.12);
      font-size:11px;
      color:#dfe6fb;
    }
    .helper{
      margin-left:6px;
      color:#a7afc0;
      font-size:11px;
    }
    .create-bar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      margin-bottom:10px;
    }
    .create-bar label{
      font-size:12px;
      color:#c9d1e3;
      font-weight:600;
    }
    .create-bar .field{
      flex:1;
      min-width:220px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .create-bar .hint{
      color:#a7afc0;
      font-size:11px;
    }
  </style>

  <div class="controls">
    <div class="search">
      <span style="opacity:.8;">üîé</span>
      <input id="feeds-q" placeholder="Search across all columns..." />
      <span class="pill" id="feeds-lastRefresh" title="Last refresh time">‚Äî</span>
    </div>

    <select id="feeds-pageSize" title="Rows per page">
      <option value="25">25</option>
      <option value="50" selected>50</option>
      <option value="100">100</option>
      <option value="200">200</option>
    </select>

    <button class="btn primary" onclick="feeds_reload(true)">Search</button>
    <button class="btn" onclick="feeds_clear()">Clear</button>

    <button class="btn primary" id="feeds-addBtn" onclick="feeds_add()">Create RSS Feed</button>
    <button class="btn" id="feeds-saveBtn" onclick="feeds_save()">Save</button>
  </div>

  <div class="create-bar">
    <div class="field">
      <label for="feeds-newUrl">Site URL to convert into RSS</label>
      <input id="feeds-newUrl" type="url" placeholder="https://www.bbc.com/news">
      <div class="hint">Paste any site link here. Click ‚ÄúCreate RSS Feed‚Äù and the AI will generate the RSS endpoint.</div>
    </div>
    <div class="field" style="max-width:220px;">
      <label for="feeds-newSource">Optional source name</label>
      <input id="feeds-newSource" type="text" placeholder="BBC">
      <div class="hint">We‚Äôll auto-fill this from the URL if left blank.</div>
    </div>
  </div>

  <div class="meta" id="feeds-meta">Loading‚Ä¶</div>

  <div class="wrap">
    <table>
      <thead>
        <tr>
          <th style="min-width:160px;">Source</th>
          <th style="min-width:320px;">Feed URL</th>
          <th style="min-width:160px;">Tags</th>
          <th style="min-width:220px;">Notes</th>
          <th style="width:90px;">Active</th>
        </tr>
      </thead>
      <tbody id="feeds-tbody"></tbody>
    </table>
  </div>

  <div class="pager">
    <button class="btn" id="feeds-prev" onclick="feeds_prev()">‚óÄ Prev</button>
    <span id="feeds-pageInfo">Page 1</span>
    <button class="btn" id="feeds-next" onclick="feeds_next()">Next ‚ñ∂</button>
    <span class="pill" id="feeds-showing" title="Rows shown on this page">‚Äî</span>
  </div>

  <div class="notice" id="feeds-notice"></div>
</div>

<script>
  window.__init_feeds = function() {
    feeds_reload(true);
  };

  let feedsState = { page: 1, pageSize: 50, q: "", totalMatches: 0, pendingUrl: "", pendingSource: "", pendingSearch: "" };

  const F = (id) => document.getElementById(id);

  function feeds_notice(type, msg){
    const box = F("feeds-notice");
    box.className = "notice show " + (type || "");
    box.textContent = msg || "";
  }
  function feeds_noticeClear(){
    const box = F("feeds-notice");
    box.className = "notice";
    box.textContent = "";
  }

  function feeds_clear(){
    F("feeds-q").value = "";
    feedsState.q = "";
    feedsState.page = 1;
    feeds_reload(true);
  }

  function feeds_prev(){
    if (feedsState.page > 1) { feedsState.page--; feeds_reload(false); }
  }

  function feeds_next(){
    const maxPage = Math.max(1, Math.ceil((feedsState.totalMatches||0) / feedsState.pageSize));
    if (feedsState.page < maxPage) { feedsState.page++; feeds_reload(false); }
  }

  function feeds_reload(resetPage){
    if (resetPage) feedsState.page = 1;
    feedsState.pageSize = Number(F("feeds-pageSize").value || 50);
    feedsState.q = (F("feeds-q").value || "").trim();

    feeds_notice("busy", "üîÑ Loading RSS feeds‚Ä¶");

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          feeds_notice("err", "‚ùå Failed: " + (res?.message || "No response"));
          return;
        }

        feedsState.totalMatches = res.totalMatches || 0;

        const maxPage = Math.max(1, Math.ceil((feedsState.totalMatches||0) / feedsState.pageSize));
        F("feeds-pageInfo").textContent = `Page ${res.page} / ${maxPage}`;
        const uniqueSources = new Set((res.rows || []).map(r => (r.source || "").trim()).filter(Boolean));
        F("feeds-meta").textContent =
          `Sheet: ${res.sheet} ‚Ä¢ Total rows: ${res.totalRows} ‚Ä¢ Matches: ${res.totalMatches} ‚Ä¢ Sources: ${uniqueSources.size}`;
        F("feeds-showing").textContent = `Showing: ${(res.rows || []).length}`;
        F("feeds-prev").disabled = (res.page <= 1);
        F("feeds-next").disabled = (res.page >= maxPage);

        const groupedRows = (res.rows || []).slice().sort((a, b) => {
          const aSource = (a.source || "").toLowerCase();
          const bSource = (b.source || "").toLowerCase();
          if (aSource === bSource) return (a.url || "").localeCompare(b.url || "");
          return aSource.localeCompare(bSource);
        });
        const countsBySource = groupedRows.reduce((acc, row) => {
          const key = (row.source || "").trim() || "Uncategorized";
          acc[key] = (acc[key] || 0) + 1;
          return acc;
        }, {});

        let currentSource = null;
        F("feeds-tbody").innerHTML = groupedRows.map(r => {
          const source = (r.source || "").trim() || "Uncategorized";
          const urlPreview = r.url ? `<div style="margin-top:6px;"><a href="${esc(r.url)}" target="_blank" rel="noopener noreferrer">Open</a></div>` : "";
          const groupHeader = source !== currentSource ? `
            <tr class="group-row">
              <td colspan="5">
                <div class="group-title">
                  <span>${esc(source)}</span>
                  <small>${countsBySource[source] || 0} feed(s)</small>
                </div>
              </td>
            </tr>
          ` : "";
          currentSource = source;
          return `
            ${groupHeader}
            <tr data-row="${r.rowIndex}">
              <td>
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <input type="text" value="${esc(r.source)}" data-k="source" placeholder="Source name (e.g. BBC)">
                  <span class="source-badge">${esc(source)}</span>
                </div>
              </td>
              <td>
                <input type="url" value="${esc(r.url)}" data-k="url" placeholder="https://example.com/rss.xml">
                ${urlPreview}
              </td>
              <td><input type="text" value="${esc(r.tags)}" data-k="tags" placeholder="e.g. politics, tech"></td>
              <td><input type="text" value="${esc(r.notes)}" data-k="notes" placeholder="Optional notes"></td>
              <td style="text-align:center;">
                <input type="checkbox" ${r.active ? "checked" : ""} data-k="active">
                <span class="helper">${r.active ? "On" : "Off"}</span>
              </td>
            </tr>
          `;
        }).join("");

        F("feeds-lastRefresh").textContent = new Date().toLocaleTimeString();
        let showPendingNotice = false;
        if (feedsState.pendingUrl) {
          const firstRow = F("feeds-tbody").querySelector("tr[data-row]");
          if (firstRow) {
            const urlField = firstRow.querySelector('[data-k="url"]');
            const sourceField = firstRow.querySelector('[data-k="source"]');
            if (urlField) urlField.value = feedsState.pendingUrl;
            if (sourceField) sourceField.value = feedsState.pendingSource || deriveSourceFromUrl(feedsState.pendingUrl);
            feedsState.pendingUrl = "";
            feedsState.pendingSource = "";
            feedsState.pendingSearch = "";
            feeds_notice("ok", "‚úÖ Added. Review the generated RSS URL and click Save.");
            showPendingNotice = true;
          }
        }
        if (!showPendingNotice) {
          feeds_noticeClear();
        }
      })
      .withFailureHandler(err => {
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err));
        feeds_notice("err", "‚ùå Load error: " + msg);
      })
      .ui_getRssFeeds({ page: feedsState.page, pageSize: feedsState.pageSize, q: feedsState.q });
  }

  function feeds_save(){
    const btn = F("feeds-saveBtn");
    if (btn) btn.disabled = true;
    feeds_notice("busy", "üíæ Saving‚Ä¶");

    const edits = [];
    F("feeds-tbody").querySelectorAll("tr[data-row]").forEach(tr => {
      const rowIndex = Number(tr.getAttribute("data-row"));
      const get = (k) => tr.querySelector(`[data-k="${k}"]`);
      edits.push({
        rowIndex,
        source: get("source")?.value || "",
        url: get("url")?.value || "",
        tags: get("tags")?.value || "",
        notes: get("notes")?.value || "",
        active: !!get("active")?.checked
      });
    });

    google.script.run
      .withSuccessHandler(res => {
        if (btn) btn.disabled = false;
        if (!res || !res.ok) {
          feeds_notice("err", "‚ùå Save failed: " + (res?.message || "No response"));
          return;
        }
        feeds_notice("ok", `‚úÖ Saved ${res.saved || 0} row(s).`);
        feeds_reload(false);
      })
      .withFailureHandler(err => {
        if (btn) btn.disabled = false;
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err));
        feeds_notice("err", "‚ùå Save error: " + msg);
      })
      .ui_saveRssFeeds({ edits });
  }

  function feeds_add(){
    const btn = F("feeds-addBtn");
    if (btn) btn.disabled = true;
    const newUrl = (F("feeds-newUrl")?.value || "").trim();
    const newSource = (F("feeds-newSource")?.value || "").trim();
    if (newUrl) {
      F("feeds-newUrl").value = "";
      F("feeds-newSource").value = "";
      feeds_notice("busy", "‚ú® Discovering RSS feeds‚Ä¶");
      google.script.run
        .withSuccessHandler(res => {
          if (btn) btn.disabled = false;
          if (!res || !res.ok) {
            feeds_notice("err", "‚ùå Create failed: " + (res?.message || "No response"));
            return;
          }
          const addedCount = res.addedCount || 0;
          const sourceName = res.sourceName || newSource || newUrl;
          feeds_notice("ok", addedCount
            ? `‚úÖ Added ${addedCount} feed(s) for ${sourceName}.`
            : "‚ÑπÔ∏è No new feeds added (already existed).");
          F("feeds-q").value = sourceName;
          feeds_reload(true);
        })
        .withFailureHandler(err => {
          if (btn) btn.disabled = false;
          const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err));
          feeds_notice("err", "‚ùå Create error: " + msg);
        })
        .ui_createRssFeedFromUrl({ url: newUrl, sourceName: newSource });
      return;
    }

    feeds_notice("busy", "‚ûï Adding new feed row‚Ä¶");
    google.script.run
      .withSuccessHandler(res => {
        if (btn) btn.disabled = false;
        if (!res || !res.ok) {
          feeds_notice("err", "‚ùå Add failed: " + (res?.message || "No response"));
          return;
        }
        feeds_notice("ok", "‚úÖ New feed row added.");
        if (feedsState.pendingSearch) {
          F("feeds-q").value = feedsState.pendingSearch;
        }
        feeds_reload(true);
      })
      .withFailureHandler(err => {
        if (btn) btn.disabled = false;
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err));
        feeds_notice("err", "‚ùå Add error: " + msg);
      })
      .ui_addRssFeed();
  }

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function deriveSourceFromUrl(url){
    try {
      const host = new URL(url).hostname.replace(/^www\./, "");
      const name = host.split(".")[0] || host;
      return name ? name.charAt(0).toUpperCase() + name.slice(1) : "";
    } catch (e) {
      return "";
    }
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && document.activeElement === F("feeds-q")) feeds_reload(true);
  });
  document.addEventListener("change", (e) => {
    if (e.target && e.target.id === "feeds-pageSize") feeds_reload(true);
  });
</script>
