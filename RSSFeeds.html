<div id="feeds-root" style="padding:12px;">
  <style>
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    .search{
      flex:1; min-width:220px;
      display:flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius:999px; padding:10px 12px;
      color:#e8eaf0;
    }
    .search input{ border:0; outline:0; background:transparent; color:#e8eaf0; width:100%; font-size:13px; }

    .btn, select{
      border-radius:999px; border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:#e8eaf0;
      padding:10px 12px; font-size:12px;
    }
    .btn{ cursor:pointer; }
    .btn.primary{ border-color: rgba(122,162,255,.45); background: rgba(122,162,255,.16); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .meta{ color:#a7afc0; font-size:12px; margin-bottom:8px; }

    .wrap{ border:1px solid rgba(255,255,255,.08); border-radius:14px; overflow:auto; max-height:72vh; }
    table{ width:100%; border-collapse:collapse; font-size:12px; min-width:900px; }
    thead th{
      position:sticky; top:0; z-index:2;
      background: rgba(17,21,34,.90);
      color:#a7afc0; font-weight:600;
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px;
      text-align:left;
      white-space: nowrap;
    }
    tbody td{ border-bottom:1px solid rgba(255,255,255,.06); padding:10px; vertical-align:top; }
    tbody tr:nth-child(2n) td{ background: rgba(255,255,255,.02); }

    input[type="text"], input[type="url"]{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:#e8eaf0;
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
      outline:none;
    }

    a{ color:#7aa2ff; text-decoration:none; word-break:break-all; }
    a:hover{ text-decoration:underline; }

    .pager{ display:flex; gap:8px; align-items:center; margin-top:10px; color:#a7afc0; font-size:12px; flex-wrap: wrap; }
    .pill{
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-size: 11px;
      color:#a7afc0;
    }

    .notice{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px 12px;
      color:#e8eaf0;
      font-size:12px;
      white-space:pre-wrap;
      display:none;
    }
    .notice.show{ display:block; }
    .notice.ok{  border-color: rgba(122,255,170,.30); background: rgba(122,255,170,.10); }
    .notice.err{ border-color: rgba(255,120,120,.35); background: rgba(255,120,120,.12); }
    .notice.busy{border-color: rgba(122,162,255,.35); background: rgba(122,162,255,.10); }
  </style>

  <div class="controls">
    <div class="search">
      <span style="opacity:.8;">üîé</span>
      <input id="feeds-q" placeholder="Search across all columns..." />
      <span class="pill" id="feeds-lastRefresh" title="Last refresh time">‚Äî</span>
    </div>

    <select id="feeds-pageSize" title="Rows per page">
      <option value="25">25</option>
      <option value="50" selected>50</option>
      <option value="100">100</option>
      <option value="200">200</option>
    </select>

    <button class="btn primary" onclick="feeds_reload(true)">Search</button>
    <button class="btn" onclick="feeds_clear()">Clear</button>

    <button class="btn primary" id="feeds-addBtn" onclick="feeds_add()">Add Feed</button>
    <button class="btn" id="feeds-saveBtn" onclick="feeds_save()">Save</button>
  </div>

  <div class="meta" id="feeds-meta">Loading‚Ä¶</div>

  <div class="wrap">
    <table>
      <thead>
        <tr>
          <th style="min-width:160px;">Source</th>
          <th style="min-width:320px;">Feed URL</th>
          <th style="min-width:160px;">Tags</th>
          <th style="min-width:220px;">Notes</th>
          <th style="width:90px;">Active</th>
        </tr>
      </thead>
      <tbody id="feeds-tbody"></tbody>
    </table>
  </div>

  <div class="pager">
    <button class="btn" id="feeds-prev" onclick="feeds_prev()">‚óÄ Prev</button>
    <span id="feeds-pageInfo">Page 1</span>
    <button class="btn" id="feeds-next" onclick="feeds_next()">Next ‚ñ∂</button>
    <span class="pill" id="feeds-showing" title="Rows shown on this page">‚Äî</span>
  </div>

  <div class="notice" id="feeds-notice"></div>
</div>

<script>
  window.__init_feeds = function() {
    feeds_reload(true);
  };

  let feedsState = { page: 1, pageSize: 50, q: "", totalMatches: 0 };

  const F = (id) => document.getElementById(id);

  function feeds_notice(type, msg){
    const box = F("feeds-notice");
    box.className = "notice show " + (type || "");
    box.textContent = msg || "";
  }
  function feeds_noticeClear(){
    const box = F("feeds-notice");
    box.className = "notice";
    box.textContent = "";
  }

  function feeds_clear(){
    F("feeds-q").value = "";
    feedsState.q = "";
    feedsState.page = 1;
    feeds_reload(true);
  }

  function feeds_prev(){
    if (feedsState.page > 1) { feedsState.page--; feeds_reload(false); }
  }

  function feeds_next(){
    const maxPage = Math.max(1, Math.ceil((feedsState.totalMatches||0) / feedsState.pageSize));
    if (feedsState.page < maxPage) { feedsState.page++; feeds_reload(false); }
  }

  function feeds_reload(resetPage){
    if (resetPage) feedsState.page = 1;
    feedsState.pageSize = Number(F("feeds-pageSize").value || 50);
    feedsState.q = (F("feeds-q").value || "").trim();

    feeds_notice("busy", "üîÑ Loading RSS feeds‚Ä¶");

    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.ok) {
          feeds_notice("err", "‚ùå Failed: " + (res?.message || "No response"));
          return;
        }

        feedsState.totalMatches = res.totalMatches || 0;

        const maxPage = Math.max(1, Math.ceil((feedsState.totalMatches||0) / feedsState.pageSize));
        F("feeds-pageInfo").textContent = `Page ${res.page} / ${maxPage}`;
        F("feeds-meta").textContent =
          `Sheet: ${res.sheet} ‚Ä¢ Total rows: ${res.totalRows} ‚Ä¢ Matches: ${res.totalMatches}`;
        F("feeds-showing").textContent = `Showing: ${(res.rows || []).length}`;
        F("feeds-prev").disabled = (res.page <= 1);
        F("feeds-next").disabled = (res.page >= maxPage);

        F("feeds-tbody").innerHTML = (res.rows || []).map(r => {
          const urlPreview = r.url ? `<div style="margin-top:6px;"><a href="${esc(r.url)}" target="_blank" rel="noopener noreferrer">Open</a></div>` : "";
          return `
            <tr data-row="${r.rowIndex}">
              <td><input type="text" value="${esc(r.source)}" data-k="source"></td>
              <td>
                <input type="url" value="${esc(r.url)}" data-k="url">
                ${urlPreview}
              </td>
              <td><input type="text" value="${esc(r.tags)}" data-k="tags"></td>
              <td><input type="text" value="${esc(r.notes)}" data-k="notes"></td>
              <td style="text-align:center;">
                <input type="checkbox" ${r.active ? "checked" : ""} data-k="active">
              </td>
            </tr>
          `;
        }).join("");

        F("feeds-lastRefresh").textContent = new Date().toLocaleTimeString();
        feeds_noticeClear();
      })
      .withFailureHandler(err => {
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err));
        feeds_notice("err", "‚ùå Load error: " + msg);
      })
      .ui_getRssFeeds({ page: feedsState.page, pageSize: feedsState.pageSize, q: feedsState.q });
  }

  function feeds_save(){
    const btn = F("feeds-saveBtn");
    if (btn) btn.disabled = true;
    feeds_notice("busy", "üíæ Saving‚Ä¶");

    const edits = [];
    F("feeds-tbody").querySelectorAll("tr").forEach(tr => {
      const rowIndex = Number(tr.getAttribute("data-row"));
      const get = (k) => tr.querySelector(`[data-k="${k}"]`);
      edits.push({
        rowIndex,
        source: get("source")?.value || "",
        url: get("url")?.value || "",
        tags: get("tags")?.value || "",
        notes: get("notes")?.value || "",
        active: !!get("active")?.checked
      });
    });

    google.script.run
      .withSuccessHandler(res => {
        if (btn) btn.disabled = false;
        if (!res || !res.ok) {
          feeds_notice("err", "‚ùå Save failed: " + (res?.message || "No response"));
          return;
        }
        feeds_notice("ok", `‚úÖ Saved ${res.saved || 0} row(s).`);
        feeds_reload(false);
      })
      .withFailureHandler(err => {
        if (btn) btn.disabled = false;
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err));
        feeds_notice("err", "‚ùå Save error: " + msg);
      })
      .ui_saveRssFeeds({ edits });
  }

  function feeds_add(){
    const btn = F("feeds-addBtn");
    if (btn) btn.disabled = true;
    feeds_notice("busy", "‚ûï Adding new feed row‚Ä¶");

    google.script.run
      .withSuccessHandler(res => {
        if (btn) btn.disabled = false;
        if (!res || !res.ok) {
          feeds_notice("err", "‚ùå Add failed: " + (res?.message || "No response"));
          return;
        }
        feeds_notice("ok", "‚úÖ New feed row added.");
        feeds_reload(true);
      })
      .withFailureHandler(err => {
        if (btn) btn.disabled = false;
        const msg = err?.message || (typeof err === "string" ? err : JSON.stringify(err));
        feeds_notice("err", "‚ùå Add error: " + msg);
      })
      .ui_addRssFeed();
  }

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && document.activeElement === F("feeds-q")) feeds_reload(true);
  });
  document.addEventListener("change", (e) => {
    if (e.target && e.target.id === "feeds-pageSize") feeds_reload(true);
  });
</script>
