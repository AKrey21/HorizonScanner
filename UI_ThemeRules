/*********************************
 * UI_RSSFeeds.gs — RSS Feeds UI API (collision-safe)
 * Sheet starts at row RSS_FEEDS_START_ROW, columns A:E by default:
 *   A: Source
 *   B: Feed URL
 *   C: Tags / Theme (optional)
 *   D: Notes (optional)
 *   E: Active (checkbox)
 *********************************/

// Fallbacks (won’t error if you haven’t defined constants elsewhere)
// Renamed to reduce collision risk across files
const RSS_UI_FEEDS_SHEET_FALLBACK = "RSS Feeds";
const RSS_UI_FEEDS_START_ROW_FALLBACK = 2;
const RSS_UI_FEEDS_COLS_FALLBACK = 5;

function rss_getRssFeedsSheetName_() {
  // If you already have a constant elsewhere, we’ll use it.
  if (typeof RSS_FEEDS_SHEET === "string" && RSS_FEEDS_SHEET.trim()) return RSS_FEEDS_SHEET.trim();
  if (typeof SC_RSS_SHEET === "string" && SC_RSS_SHEET.trim()) return SC_RSS_SHEET.trim();
  return RSS_UI_FEEDS_SHEET_FALLBACK;
}

function rss_getRssFeedsStartRow_() {
  if (typeof RSS_FEEDS_START_ROW === "number" && RSS_FEEDS_START_ROW > 0) return RSS_FEEDS_START_ROW;
  return RSS_UI_FEEDS_START_ROW_FALLBACK;
}

function rss_getRssFeedsCols_() {
  if (typeof RSS_FEEDS_COLS === "number" && RSS_FEEDS_COLS > 0) return RSS_FEEDS_COLS;
  return RSS_UI_FEEDS_COLS_FALLBACK;
}

// Renamed to avoid collisions with other helperFunctions.gs etc.
function rss_clampInt_(n, min, max) {
  n = Number(n);
  if (!Number.isFinite(n)) n = min;
  n = Math.floor(n);
  return Math.max(min, Math.min(max, n));
}

// Renamed to avoid collisions with other helperFunctions.gs etc.
function rss_rowMatchesQuery_(vals, qLower) {
  if (!qLower) return true;
  for (let i = 0; i < vals.length; i++) {
    const s = String(vals[i] ?? "").toLowerCase();
    if (s.includes(qLower)) return true;
  }
  return false;
}

// Safe spreadsheet getter: prefer your shared getSpreadsheet_(), fallback to active
function rss_getSpreadsheetSafe_() {
  if (typeof getSpreadsheet_ === "function") return getSpreadsheet_();
  return SpreadsheetApp.getActiveSpreadsheet();
}

/**
 * GET RSS Feeds (paged + search)
 * params: { page: 1.., pageSize: 10/25/50/100, q: "search" }
 */
function ui_getRssFeeds(params) {
  try {
    params = params || {};
    const q = String(params.q || "").trim();
    const qLower = q.toLowerCase();

    const pageSize = rss_clampInt_(params.pageSize || 50, 1, 500);
    const page = rss_clampInt_(params.page || 1, 1, 999999);

    const ss = rss_getSpreadsheetSafe_();
    const sheetName = rss_getRssFeedsSheetName_();
    const sh = ss.getSheetByName(sheetName);
    if (!sh) return { ok: false, message: `Sheet not found: "${sheetName}"` };

    const startRow = rss_getRssFeedsStartRow_();
    const lastRow = sh.getLastRow();
    if (lastRow < startRow) {
      return { ok: true, sheet: sheetName, page, pageSize, totalRows: 0, totalMatches: 0, rows: [] };
    }

    const cols = rss_getRssFeedsCols_();
    const height = lastRow - startRow + 1;

    const values = sh.getRange(startRow, 1, height, cols).getValues();

    // Build row objects + filter blanks
    const allRows = values
      .map((r, idx) => {
        const activeRaw = r[4];
        const active =
          activeRaw === true ||
          activeRaw === 1 ||
          String(activeRaw).trim().toLowerCase() === "true";

        return {
          rowIndex: startRow + idx,
          source: String(r[0] || "").trim(),
          url: String(r[1] || "").trim(),
          tags: String(r[2] || "").trim(),
          notes: String(r[3] || "").trim(),
          active
        };
      })
      .filter(r => r.source || r.url || r.tags || r.notes);

    // Search filter
    const filtered = allRows.filter(r =>
      rss_rowMatchesQuery_([r.source, r.url, r.tags, r.notes, r.active], qLower)
    );

    const totalMatches = filtered.length;

    // Paging
    const startIdx = (page - 1) * pageSize;
    const pageRows = filtered.slice(startIdx, startIdx + pageSize);

    return {
      ok: true,
      sheet: sheetName,
      page,
      pageSize,
      totalRows: allRows.length,
      totalMatches,
      rows: pageRows
    };

  } catch (err) {
    return { ok: false, message: err?.message || String(err), stack: err?.stack || "" };
  }
}

/**
 * SAVE edits
 * payload: { edits: [{rowIndex, source, url, tags, notes, active}] }
 */
function ui_saveRssFeeds(payload) {
  try {
    payload = payload || {};
    const edits = Array.isArray(payload.edits) ? payload.edits : [];
    if (!edits.length) return { ok: true, saved: 0 };

    const ss = rss_getSpreadsheetSafe_();
    const sheetName = rss_getRssFeedsSheetName_();
    const sh = ss.getSheetByName(sheetName);
    if (!sh) return { ok: false, message: `Sheet not found: "${sheetName}"` };

    const startRow = rss_getRssFeedsStartRow_();

    edits.forEach(e => {
      const rowIndex = Number(e.rowIndex);
      if (!rowIndex || rowIndex < startRow) return;

      sh.getRange(rowIndex, 1, 1, 5).setValues([[
        String(e.source || "").trim(),
        String(e.url || "").trim(),
        String(e.tags || "").trim(),
        String(e.notes || "").trim(),
        e.active === true
      ]]);
    });

    return { ok: true, saved: edits.length };
  } catch (err) {
    return { ok: false, message: err?.message || String(err), stack: err?.stack || "" };
  }
}

/**
 * ADD new RSS feed row (copies formatting + data validation from template row)
 */
function ui_addRssFeed() {
  try {
    const ss = rss_getSpreadsheetSafe_();
    const sheetName = rss_getRssFeedsSheetName_();
    const sh = ss.getSheetByName(sheetName);
    if (!sh) return { ok: false, message: `Sheet not found: "${sheetName}"` };

    const startRow = rss_getRssFeedsStartRow_();
    const lastRow = Math.max(sh.getLastRow(), startRow - 1);

    sh.insertRowAfter(lastRow);
    const newRow = lastRow + 1;

    const template = sh.getRange(startRow, 1, 1, 5);
    const dest = sh.getRange(newRow, 1, 1, 5);

    template.copyTo(dest, SpreadsheetApp.CopyPasteType.PASTE_FORMAT, false);
    template.copyTo(dest, SpreadsheetApp.CopyPasteType.PASTE_DATA_VALIDATION, false);

    dest.clearContent();
    sh.getRange(newRow, 5).setValue(true);

    return {
      ok: true,
      row: { rowIndex: newRow, source: "", url: "", tags: "", notes: "", active: true }
    };
  } catch (err) {
    return { ok: false, message: err?.message || String(err), stack: err?.stack || "" };
  }
}

/**
 * Optional: quick debug ping to verify the web app is calling the right deployment
 */
function ui_ping() {
  return { ok: true, ts: new Date().toISOString() };
}
